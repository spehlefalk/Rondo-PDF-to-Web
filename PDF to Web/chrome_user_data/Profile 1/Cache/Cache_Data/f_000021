const __vite__fileDeps=["assets/ContextChat-y4oenQxV.js","assets/ContextChat.vue_vue_type_script_setup_true_lang-CLWrUqWg.js","assets/vendor-DP6O45ke.js","assets/vendor-Bi5_IIMz.css","assets/index-Dsay-W0g.js","assets/index-DNLwZrWR.css","assets/chat.store-WmbfM-QW.js","assets/index-CJWmrMZX.js","assets/computedDebounced-DaN6cEOJ.js","assets/upload.store-CU1g3nY9.js","assets/useServiceEventListener-DCg5b4lA.js"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{u as Is}from"./useRouterGoBack-CwoBDFsH.js";import{a2 as js,a as He,a3 as Bs,a4 as We,$ as Fs,f as Os,W as Oe,a5 as Rs,F as be,d as zs,a6 as Re,N as qs,n as Ke,P as Ms,Q as Ns,K as Gs,R as Ls,M as Hs,a7 as Ws,X as Ks,a8 as Qs,S as Js,b as Xs,l as Ys}from"./index-Dsay-W0g.js";import{a as K,r as B,u as se,b as J,o as a,az as w,g as t,aB as ne,e as S,j as x,h as s,t as m,c as e,f as n,i as I,l as Y,fA as Qe,Y as b,ah as X,e1 as le,W as he,fB as Zs,fC as et,ez as ae,eA as $e,e2 as ze,w as Ce,s as Je,eX as Xe,k as Q,fx as st,m as Ee,fD as tt,aO as nt,f0 as we,ae as at,e0 as ot,ey as lt,fE as it,fs as rt,fF as qe,a3 as dt,U as Ye,eI as ut,eG as mt,eH as ct,eo as pt,ep as ft,fG as gt,fH as vt,aK as Ze,fI as yt,_ as _e,fb as ht,en as _t,fc as kt}from"./vendor-DP6O45ke.js";import{f as bt,g as $t,h as es,a as Me,b as Ct,d as Et,e as wt,_ as At,c as xt}from"./AddressPropertyForm.vue_vue_type_script_setup_true_lang-lISGFsxa.js";import{_ as Tt,a as St,A as Ut,u as Vt,b as Dt,c as Pt}from"./useCustomForms-D5R88O9b.js";import{O as It}from"./index-DlSjbakU.js";import{_ as Ae}from"./AssignmentEventName.vue_vue_type_script_setup_true_lang-DS0TEwVk.js";import{u as jt,r as Ne}from"./assignment-events.helpers-CWYDlrj6.js";import{u as ss}from"./AddressMap.vue_vue_type_script_setup_true_lang-CdLWc4NG.js";import{g as Bt}from"./colorHelpers-Di3bZx5J.js";import{u as ts}from"./chat.store-WmbfM-QW.js";import{_ as Ft}from"./SelectCustomer.vue_vue_type_script_setup_true_lang-WMN4F6Er.js";import{_ as Ot}from"./ContextChat.vue_vue_type_script_setup_true_lang-CLWrUqWg.js";import{i as Rt}from"./index-DruqRWsa.js";import{i as zt}from"./index-C8ho11FL.js";import{i as qt,a as Mt}from"./index-vXJwK2G8.js";import{u as Nt,t as Gt}from"./index-CsgZOv_I.js";import{a as ke}from"./index-5ygR7EGk.js";import{i as Lt}from"./index-CzNUN5hh.js";import{a as Ht,u as Wt,F as Kt}from"./useFullcalendar-CLA5ahNS.js";import{_ as ns}from"./ArtesaTimePickerForCalendar.vue_vue_type_style_index_0_lang-Bin9FMqz.js";import{_ as Qt}from"./SelectUser.vue_vue_type_script_setup_true_lang-ecQ9vvXJ.js";import{_ as Jt}from"./SelectAssignmentEventType.vue_vue_type_script_setup_true_lang-1-5PYO1q.js";import{_ as Xt}from"./AssignmentEventWorkPeriodTable.vue_vue_type_script_setup_true_lang-BjGHLbjN.js";import{u as as}from"./useContainerQuery-B2PH6oRc.js";import{_ as Yt}from"./TabCustomForms.vue_vue_type_script_setup_true_lang-BPPIcFQC.js";import{a as Zt}from"./arrayById-BY_S6K77.js";import{u as Ge}from"./useIsUserOfRole-CsP1Paeq.js";import{u as en}from"./useServiceEventListener-DCg5b4lA.js";const sn={class:"flex"},tn={class:"flex-1"},nn={class:"flex flex-wrap justify-between"},an={key:0,class:"flex-grow text-end text-sm text-slate-600"},on={class:"max-h-[calc(100vh-40px)] box-border overflow-y-auto"},ln={class:"flex justify-end"},Le=K({__name:"CardAssignmentEventsEntry",props:{event:{},tasks:{},isEditAssignmentUsersActive:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1}},setup(p){const E=B(!1),{t:r}=se(),l=jt();function c(y){return js(y.startsAt,y.endsAt,{isAllDay:y.isAllDay})}return(y,$)=>{const g=J("font-awesome-icon"),P=Y,A=Qe;return a(),w("div",sn,[t("div",tn,[t("div",nn,[t("div",{class:ne(["basis-auto flex-grow-0 flex-shrink items-center leading-tight",{"text-gray-400":!y.isEditAssignmentUsersActive&&!y.event.confirmedAt&&!y.event.completedAt}])},[y.event.completedAt?(a(),S(g,{key:0,icon:"check","fixed-width":"",class:"mr-0.5 text-xs"})):x("",!0),s(Ae,{value:y.event},null,8,["value"])],2),y.isEditAssignmentUsersActive?x("",!0):(a(),w("div",an,m(c(y.event)),1))]),s(bt,{event:y.event,readonly:!y.isEditAssignmentUsersActive,class:"px-1",onAddUser:$[0]||($[0]=({eventUsers:h})=>e(l)(y.event,h.length,{showNotification:!0}))},null,8,["event","readonly"])]),y.isEditAssignmentUsersActive?x("",!0):(a(),S($t,{key:0,"read-only":"",value:y.event,class:"ml-1"},null,8,["value"])),s(A,{placement:"bottom-end",width:450,trigger:"click",visible:e(E),class:"ml-2","popper-class":"!bg-gray-100",persistent:!1,"popper-options":{modifiers:[{name:"preventOverflow",options:{altAxis:!0,boundary:"viewport",padding:5,escapeWithReference:!0}},{name:"eventListeners",options:{scroll:!1}}]},disabled:y.readonly},{reference:n(()=>[s(P,{text:"",size:"small",onClick:$[1]||($[1]=()=>E.value=!0)},{default:n(()=>[s(g,{icon:"ellipsis-v",class:"text-xs"})]),_:1})]),default:n(()=>[t("div",on,[s(e(It),{options:{ignore:[".el-popper",".v-popper__popper"]},onTrigger:$[3]||($[3]=()=>E.value=!1)},{default:n(()=>[s(es,{event:y.event,tasks:y.tasks,class:"mb-2"},null,8,["event","tasks"]),t("div",ln,[s(P,{class:"px-2",text:"",onClick:$[2]||($[2]=()=>E.value=!1)},{default:n(()=>[I(m(e(r)("actions.Close")),1)]),_:1})])]),_:1})])]),_:1},8,["visible","disabled"])])}}}),rn={key:0,class:"border-b border-gray-200"},dn={class:"text-gray-500 text-sm font-bold bg-gray-200 py-0.5 pl-3 pr-1 flex justify-between items-center leading-8"},un={key:0},mn={key:1},cn=K({__name:"CardAssignmentEvents",props:{assignment:{},events:{},eventGroups:{},eventUsers:{},tasksByEventUuid:{},isEditAssignmentUsersActive:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1}},setup(p,{expose:E}){const r=p,{t:l}=se(),c=He(),{groupsAndEventsToShow:y}=ss({events:b(()=>r.events),groups:b(()=>r.eventGroups)}),$=b(()=>{const h=[];return y.value.forEach(_=>{if(_.isGroup){const{group:i,events:D}=_.element;if(!D.length)return;const o=[];D.forEach(d=>{const v=r.eventUsers.filter(k=>k.eventUuid===d.uuid);o.push({uuid:d.uuid,type:"event",event:d,eventUsers:v})}),h.push({uuid:i.uuid,type:"group",group:i,eventData:o})}else{const i=_.element,D=r.eventUsers.filter(o=>o.eventUuid===i.uuid);h.push({uuid:i.uuid,type:"event",event:i,eventUsers:D})}}),h});function g(h){return h.every(_=>!!_.confirmedAt)}function P(){return A(r.events)}function A(h){g(h)?h.forEach(i=>{i.confirmedAt&&(i.confirmedAt=null,i.confirmedById=null)}):h.forEach(i=>{i.confirmedAt||(i.confirmedAt=new Date,i.confirmedById=c.value?.id??null)})}return E({confirmAllEvents:P}),(h,_)=>{const i=J("font-awesome-icon"),D=Y,o=J("ArtesaTooltip");return a(),w("div",null,[(a(!0),w(X,null,le(e($),d=>(a(),w(X,{key:d.uuid},[d.type==="group"?(a(),w("div",rn,[t("div",dn,[t("div",null,[d.group?(a(),w("span",un,m(d.group.type&&d.group.type.name),1)):(a(),w("span",mn,m(e(l)("Other")),1))]),!h.isEditAssignmentUsersActive&&!h.readonly?(a(),S(o,{key:0,effect:"dark",content:e(l)("cardAssignmentSteps.authorizeGroup",{group:d.group&&d.group.type&&d.group.type.name}),placement:"top"},{default:n(()=>[s(D,{size:"small",onClick:()=>A(d.eventData.map(v=>v.event))},{default:n(()=>[s(i,{icon:["far","thumbs-up"],class:"text-xs"})]),_:2},1032,["onClick"])]),_:2},1032,["content"])):x("",!0)]),(a(!0),w(X,null,le(d.eventData,({event:v})=>(a(),S(Le,{key:v.uuid,event:v,tasks:h.tasksByEventUuid[v.uuid]??[],"is-edit-assignment-users-active":h.isEditAssignmentUsersActive,readonly:h.readonly,class:ne(["border-l-2 border-r border-gray-200 py-1 pl-2",[h.readonly?"pr-2":"pr-1"]])},null,8,["event","tasks","is-edit-assignment-users-active","readonly","class"]))),128))])):(a(),S(Le,{key:1,event:d.event,tasks:h.tasksByEventUuid[d.event.uuid]??[],"is-edit-assignment-users-active":h.isEditAssignmentUsersActive,readonly:h.readonly,class:ne(["py-1 pl-2",[h.readonly?"pr-2":"pr-1"]])},null,8,["event","tasks","is-edit-assignment-users-active","readonly","class"]))],64))),128))])}}}),pn=p=>{const E=`${p.singleObjectRelation}Id`,r=`${p.singleObjectRelation}Uuid`,l=`${p.multiObjectRelation}Id`;`${p.multiObjectRelation}`;const c=v=>{let k;const U=e(p.params);if(e(p.fetchParams),k=U,k)k=Zs({query:{}},k);else return{query:{}};return k},y=b(()=>{const v=he(p.singleObject);if(!v)return null;const k=c();return k.query[r]=v.uuid,k}),$=b(()=>{const v=he(p.singleObject);if(!v?.id)return null;const k=c();return k.query[E]=v.id,k}),{data:g,hasChanges:P,save:A,cancel:h,markForRemove:_,reset:i}=p.mnStore.useFeathersItems({params:y,fetchParams:$,limit:p.limit,localOnly:p.localOnly}),D=b(()=>[...new Set(g.value.map(v=>v[l]))]),o=b(()=>p.multiStore.localFind(D.value));function d(v){const k=he(p.singleObject);if(!k)return;let U=Object.assign({},p.data,{[E]:k.id,[l]:v.id});p.beforeAdd&&(U=p.beforeAdd(U,{mnItems:g.value})),p.mnStore.construct(U)}return{mnItems:g,manyItems:o,removeTemp:_,hasChanges:P,save:A,cancel:h,reset:i,addItem:d}},os=p=>{const E=Bs().createScope(),r=We().createScope(),{mnItems:l,manyItems:c,addItem:y,removeTemp:$,reset:g,save:P,hasChanges:A}=pn({mnStore:E,singleObject:p.assignment,multiStore:r,singleObjectRelation:"assignment",multiObjectRelation:"type",beforeAdd:(h,{mnItems:_})=>{const i=et(_,"order")?.order||0;return h.order=i+1,h},params:b(()=>({query:{$sort:{order:1}}})),localOnly:p.localOnly});return{assignmentTags:l,selectedAssignmentTagTypes:c,addAssignmentTagByTagType:y,removeTempAssignmentTag:$,resetTags:g,saveTags:P,tagsHaveChanges:A}},fn={key:0},gn={class:"md:flex"},vn={key:0,class:"flex items-center mr-1"},yn={class:"flex flex-1 flex-wrap"},hn={class:"flex flex-wrap flex-1"},_n=["onClick"],kn={key:1,class:"flex flex-1 items-center"},bn={key:0,class:"mt-0.5 ml-1"},$n={key:0},Cn={key:1},En={class:"flex items-center"},wn={class:"px-2"},An=K({__name:"AssignmentTags",props:{assignment:{type:Object,required:!0},readonly:{type:Boolean,default:!1}},setup(p){const E=p,{t:r}=se(),l=We().createScope(),c=B(!1),{serverCount:y}=l.useCount({params:{query:{}}}),$=b(()=>(y.value??0)>0),{assignmentTags:g,selectedAssignmentTagTypes:P,addAssignmentTagByTagType:A,removeTempAssignmentTag:h}=os({assignment:()=>E.assignment,localOnly:!0}),_=b(()=>P.value.length?{query:{id:{$nin:P.value.map(D=>D.id)},$sort:{order:1}}}:{});function i(D){c.value&&(D.isImportant=!D.isImportant)}return(D,o)=>{const d=J("font-awesome-icon"),v=Y,k=J("ArtesaTooltip");return e($)&&(!p.readonly||e(g).length)?(a(),w("div",fn,[t("div",gn,[e(g).length?(a(),w("div",vn,m(e(r)("assignmentTags.category",2))+": ",1)):x("",!0),t("div",yn,[t("div",hn,[e(g).length?(a(!0),w(X,{key:0},le(e(g),U=>(a(),w("div",{key:U.uuid,class:ne(["flex flex-1 border border-l-8 rounded m-0.5 min-w-44",{"cursor-pointer":e(c),"font-bold":U.isImportant}]),style:ze({"border-color":U.type?.color||"#000","background-color":e(Bt)(U.type?.color,.08)}),onClick:()=>!p.readonly&&i(U)},[t("div",{class:"flex-1 py-1 px-2",style:ze({"box-shadow":`inset 2px 0 5px -3px ${U.type?.color}`})},m(U.type?.name),5),e(c)&&!p.readonly?(a(),S(v,{key:0,text:"",size:"default",class:"px-2",onClick:()=>e(h)(U)},{default:n(()=>[s(d,{icon:"times"})]),_:2},1032,["onClick"])):x("",!0)],14,_n))),128)):(a(),w("div",kn,m(e(r)("assignmentTags.noAssignmentCategories")),1))]),p.readonly?x("",!0):(a(),w("div",bn,[e(c)?(a(),w("div",$n,[s(k,{effect:"dark",content:e(r)("assignmentTags.saveCategory"),placement:"top"},{default:n(()=>[s(v,{size:"default",type:"primary",onClick:o[0]||(o[0]=()=>c.value=!1)},{default:n(()=>[s(d,{icon:"check"})]),_:1})]),_:1},8,["content"])])):(a(),w("div",Cn,[s(k,{effect:"dark",content:e(r)("assignmentTags.assignmentCategory",2),placement:"top"},{default:n(()=>[s(v,{size:"default",onClick:o[1]||(o[1]=()=>c.value=!0)},{default:n(()=>[s(d,{icon:"pencil-alt"})]),_:1})]),_:1},8,["content"])]))]))])]),ae(t("div",En,[t("div",wn,[s(d,{icon:"plus"})]),s(Fs,{"model-value":null,store:e(l),params:e(_),"label-field":"name","color-field":"color","show-border":"",placeholder:e(r)("assignmentTags.addCategory"),size:"default",onChange:e(A)},null,8,["store","params","placeholder","onChange"])],512),[[$e,e(c)]])])):x("",!0)}}}),xn={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 gap-x-2 grid-rows-[auto,1fr]"},Tn={class:"flex justify-between"},Sn={class:"flex justify-between"},Un={class:"flex justify-between"},Vn={class:"flex gap-2"},Dn={class:"flex justify-between"},Pn={class:"flex justify-between"},In={key:0},jn={class:"flex justify-between"},Bn={class:"flex w-full h-16"},Fn={class:"grid grid-cols-1 md:grid-cols-2 gap-2 mt-4"},On={class:"border border-gray-200 px-3 py-2 rounded"},Rn={class:"border border-gray-200 px-3 py-2 rounded"},zn={class:"flex justify-end mt-4"},qn={class:"flex justify-end mt-4"},Mn={class:"flex justify-end mt-4"},Nn={class:"flex justify-end mt-4"},Gn=nt(()=>Os(()=>import("./ContextChat-y4oenQxV.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10]))),Ln=K({__name:"TabGeneral",props:{assignment:{},events:{},eventGroups:{},eventUsers:{},tasksByEventUuid:{},hideChat:{type:Boolean},readonly:{type:Boolean,default:!1}},setup(p){const E=p,{t:r}=se(),l=ts(),c=b(()=>({assignmentId:E.assignment.id})),{hasUnreadMessages:y,markAsRead:$}=l.useHasUnreadChatMessages(c);Ce(()=>y.value&&!E.hideChat,()=>{$()});const g=B(),P=B(!1),A=B(!1),h=B(!1),_=B(!1),i=Je(!1);function D(){g.value?.confirmAllEvents()}return(o,d)=>{const v=J("font-awesome-icon"),k=st,U=Y,M=J("ArtesaTooltip"),F=Ee,O=we;return a(),w("div",null,[s(An,{assignment:o.assignment,readonly:o.readonly,class:"mb-2"},null,8,["assignment","readonly"]),t("div",xn,[t("div",null,[s(k,{class:"mb-2"},{header:n(()=>[t("div",Tn,[t("span",null,[s(v,{icon:"images",class:"mr-2 text-xs"}),I(" "+m(e(r)("file",2)),1)])])]),default:n(()=>[t("div",null,m(e(r)("temp.DetailedAssignmentMovedFiles")),1)]),_:1}),s(k,{class:"mb-2"},{header:n(()=>[t("div",Sn,[t("span",null,[s(v,{icon:"building",class:"mr-2 text-xs"}),I(" "+m(e(r)("assignment.form.addressPropertyShort")),1)]),o.$can("update",o.assignment,"property")&&!o.readonly?(a(),S(U,{key:0,size:"default",onClick:d[0]||(d[0]=j=>h.value=!0)},{default:n(()=>[s(v,{icon:"pencil-alt",class:"text-xs"})]),_:1})):x("",!0)])]),default:n(()=>[s(Tt,{assignment:o.assignment},null,8,["assignment"])]),_:1})]),t("div",null,[o.assignment.customer?(a(),S(k,{key:0,class:"mb-2"},{header:n(()=>[t("div",Un,[t("span",null,[s(v,{icon:"user",class:"mr-2 text-xs"}),I(" "+m(e(r)("customer.name")),1)]),t("div",Vn,[s(U,{size:"default",onClick:d[1]||(d[1]=j=>i.value=!0)},{default:n(()=>[s(v,{icon:"exchange-alt",class:"text-xs"})]),_:1}),o.$can("update",o.assignment,"customer")&&!o.readonly?(a(),S(U,{key:0,size:"default",onClick:d[2]||(d[2]=()=>A.value=!0)},{default:n(()=>[s(v,{icon:"pencil-alt",class:"text-xs"})]),_:1})):x("",!0)])])]),default:n(()=>[s(St,{modelValue:o.assignment.customer,"onUpdate:modelValue":d[3]||(d[3]=j=>o.assignment.customer=j)},null,8,["modelValue"])]),_:1})):x("",!0),s(k,{class:"mb-2"},{header:n(()=>[t("div",Dn,[t("span",null,[s(v,{icon:"folder-open",class:"mr-2 text-xs"}),I(" "+m(e(r)("project.name")),1)]),o.$can("update",o.assignment,"project")&&!o.readonly?(a(),S(U,{key:0,size:"default",onClick:d[4]||(d[4]=()=>_.value=!0)},{default:n(()=>[s(v,{icon:"pencil-alt",class:"text-xs"})]),_:1})):x("",!0)])]),default:n(()=>[s(Me,{"model-value":o.assignment,"read-only":""},null,8,["model-value"])]),_:1})]),t("div",null,[s(k,{class:"mb-2"},{header:n(()=>[t("div",Pn,[t("div",null,[s(v,{icon:"tasks",class:"mr-2 text-xs"}),I(" "+m(e(r)("assignmentEvent.name",2)),1)]),!e(P)&&!o.readonly?(a(),S(M,{key:0,effect:"dark",content:e(r)("assignmentEvent.action.confirmAll"),placement:"top"},{default:n(()=>[s(U,{size:"default",onClick:D},{default:n(()=>[s(v,{icon:["far","thumbs-up"],class:"text-xs"})]),_:1})]),_:1},8,["content"])):x("",!0)])]),default:n(()=>[s(cn,{ref_key:"refCardAssignmentEvents",ref:g,assignment:o.assignment,events:o.events,"event-groups":o.eventGroups,"event-users":o.eventUsers,"tasks-by-event-uuid":o.tasksByEventUuid,class:"-my-2 -mx-3","is-edit-assignment-users-active":e(P),readonly:o.readonly},null,8,["assignment","events","event-groups","event-users","tasks-by-event-uuid","is-edit-assignment-users-active","readonly"])]),_:1})]),o.assignment.id&&!o.hideChat?(a(),w("div",In,[s(k,{class:"no-padding mb-2"},{header:n(()=>[t("div",jn,[t("span",null,[s(v,{icon:"folder-open",class:"mr-2 text-xs"}),I(" "+m(e(r)("chat.chat")),1)]),s(U,{size:"default",icon:e(tt),onClick:d[5]||(d[5]=j=>o.assignment.id&&e(l).openChat(e(c)))},null,8,["icon"])])]),default:n(()=>[(a(),S(Xe,null,{fallback:n(()=>[ae(t("div",Bn,null,512),[[O,!0]])]),default:n(()=>[s(e(Gn),{context:e(c)},null,8,["context"])]),_:1}))]),_:1})])):x("",!0)]),e(h)?(a(),S(F,{key:0,modelValue:e(h),"onUpdate:modelValue":d[9]||(d[9]=j=>Q(h)?h.value=j:null),title:`${e(r)("assignment.form.addressPropertyShort")} ${e(r)("actions.edit")}`,"append-to-body":"",width:"75%"},{default:n(()=>[t("h4",null,m(e(r)("assignment.form.addressProperty"))+":",1),s(Ct,{assignment:o.assignment,draggable:"",clickable:""},null,8,["assignment"]),t("div",Fn,[t("div",On,[t("h4",null,m(e(r)("assignment.property.constructionManager"))+":",1),s(Et,{modelValue:o.assignment.constructionManager,"onUpdate:modelValue":d[6]||(d[6]=j=>o.assignment.constructionManager=j)},null,8,["modelValue"])]),t("div",Rn,[t("h4",null,m(e(r)("assignment.property.architect"))+":",1),s(wt,{modelValue:o.assignment.architect,"onUpdate:modelValue":d[7]||(d[7]=j=>o.assignment.architect=j)},null,8,["modelValue"])])]),t("div",zn,[s(U,{type:"primary",onClick:d[8]||(d[8]=()=>h.value=!1)},{default:n(()=>[I(m(e(r)("OK")),1)]),_:1})])]),_:1},8,["modelValue","title"])):x("",!0),e(_)?(a(),S(F,{key:1,modelValue:e(_),"onUpdate:modelValue":d[11]||(d[11]=j=>Q(_)?_.value=j:null),title:`${e(r)("project.name")} ${e(r)("actions.edit")}`,"append-to-body":"",width:"500px"},{default:n(()=>[s(Me,{"model-value":o.assignment,"show-change-project-name":""},null,8,["model-value"]),t("div",qn,[s(U,{type:"primary",onClick:d[10]||(d[10]=()=>_.value=!1)},{default:n(()=>[I(m(e(r)("OK")),1)]),_:1})])]),_:1},8,["modelValue","title"])):x("",!0),e(A)?(a(),S(F,{key:2,modelValue:e(A),"onUpdate:modelValue":d[14]||(d[14]=j=>Q(A)?A.value=j:null),title:`${e(r)("customer.name")} ${e(r)("actions.edit")}`,"append-to-body":"",width:"500px"},{default:n(()=>[o.assignment.customer?(a(),S(At,{key:0,modelValue:o.assignment.customer,"onUpdate:modelValue":d[12]||(d[12]=j=>o.assignment.customer=j)},null,8,["modelValue"])):x("",!0),t("div",Mn,[s(U,{type:"primary",onClick:d[13]||(d[13]=()=>A.value=!1)},{default:n(()=>[I(m(e(r)("OK")),1)]),_:1})])]),_:1},8,["modelValue","title"])):x("",!0),e(i)?(a(),S(F,{key:3,modelValue:e(i),"onUpdate:modelValue":d[17]||(d[17]=j=>Q(i)?i.value=j:null),"append-to-body":"",title:`${e(r)("customer.form.change")}`,width:"500px"},{default:n(()=>[s(Ft,{modelValue:o.assignment.customer,"onUpdate:modelValue":d[15]||(d[15]=j=>o.assignment.customer=j),"label-field":"fullName"},null,8,["modelValue"]),t("div",Nn,[s(U,{type:"primary",onClick:d[16]||(d[16]=j=>i.value=!1)},{default:n(()=>[I(m(e(r)("OK")),1)]),_:1})])]),_:1},8,["modelValue","title"])):x("",!0)])}}}),Hn={class:"flex w-full h-16"},Wn=K({__name:"TabChat",props:{assignment:{type:Object,required:!0}},setup(p){const E=p,r=ts(),l=b(()=>({assignmentId:E.assignment.id})),{hasUnreadMessages:c,markAsRead:y}=r.useHasUnreadChatMessages(l);return Ce(c,()=>{y()}),($,g)=>{const P=we;return a(),S(Xe,null,{fallback:n(()=>[ae(t("div",Hn,null,512),[[P,!0]])]),default:n(()=>[s(Ot,{context:e(l),height:"calc(100vh - 190px)"},null,8,["context"])]),_:1})}}}),Kn={class:"flex mb-2"},Qn={class:"flex flex-1 items-start"},Jn={class:"max-h-[calc(100vh-40px)] box-border overflow-y-auto"},Xn={class:"flex justify-between"},Yn={class:"flex"},Zn={class:"w-48 mr-1"},ea=["data-event","onClick"],sa={class:"ml-1 text-xs"},ta={class:"flex-1"},na={key:0},aa={class:"leading-none"},oa={key:0},la={class:"artesa-resource"},ia={class:"flex"},ra={key:0,class:"ml-1"},da={key:1,class:"flex justify-end mt-2"},ua={key:0},ma={key:1},ca=K({__name:"TabGanttAssignment",props:{assignment:{},events:{},eventGroups:{},tasksByEventUuid:{},active:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1}},emits:["remove-event"],setup(p,{expose:E,emit:r}){const l=p,c=r,y=He(),{t:$}=se(),g=B(),P=B("week"),A=b(()=>l.events.filter(u=>u.startsAt&&u.endsAt)),h=at(A.value,"startsAt")?.startsAt,_=B(h?Lt(h)?ke(h,{weeks:-1}):h:new Date),i=b(()=>{let u=l.events.filter(C=>!C.startsAt||!C.endsAt);return u=qe(u,"order"),u.map(C=>({event:C,data:JSON.stringify({uuid:C.uuid})}))});ot(()=>{g.value&&new Nt(g.value,{itemSelector:".drag-resource-event"})});const D=b(()=>{let u=l.events.map(C=>C.type);return u=[...new Set(u)].filter(be),u=qe(u,"order"),u}),o=b(()=>P.value==="week"?"resourceTimelineMonth":"resourceTimelineWeek"),{isLoading:d,asyncRevertFunction:v}=Ht(),{ref:k,options:U,rerender:M}=Wt({schedulerLicenseKey:"0643100174-fcs-1684754064",plugins:[Gt,Rt,zt,qt,Mt],initialView:"resourceTimelineMonth",firstDay:1,views:{resourceTimelineWeek:{slotLabelFormat:[({date:u})=>Oe(u.marker,"EEEEEE dd.MM."),({date:u})=>u.hour.toString().padStart(2,"0")],duration:{days:14}},resourceTimelineMonth:{slotLabelFormat:[{week:"short"},({date:u})=>Oe(u.marker,"EEEEEE dd.MM.")],duration:{weeks:6}}},scrollTime:null,headerToolbar:!1,droppable:!0,height:"auto",editable:!0,eventResizableFromStart:!1,eventDurationEditable:!1,weekNumbers:!0,nowIndicator:!0,resourceAreaWidth:"180px",slotMinWidth:b(()=>o.value==="resourceTimelineMonth"?80:30),resourceAreaColumns:b(()=>[{field:"title",headerContent:$("assignmentEvent.name",2)}]),events:b(()=>A.value.map(u=>{const C={start:u.startsAt,end:u.endsAt,resourceId:u.typeUuid,extendedProps:{event:u,timespanFormattedDays:u.workDays<2?$("assignmentEvent.durationTime",{duration:parseFloat((u.workingTimePerDay/3600).toFixed(2))}):$("assignmentEvent.durationDaysAndTime",{days:u.workDays,duration:parseFloat((u.workingTimePerDay/3600).toFixed(2))})},title:u.name||u.type?.name||"",classNames:"!bg-primary h-8"};return(!u.confirmedAt||u.completedAt)&&(C.classNames+=" opacity-60",u.completedAt&&(C.classNames+=" line-through")),C})),resources:b(()=>D.value.map((u,C)=>{let R="";const ee=A.value.filter(G=>G.type===u);return ee.length||(R="text-gray-400"),{id:u?.uuid,title:u?.name,index:C,extendedProps:{eventType:u,assignedEvents:ee,classNames:R},resourceClassNames:R}})),resourceOrder:"index",defaultTimedEventDuration:"01:00",eventResourceEditable:!1,eventClick:u=>{const C=u.event.extendedProps.event;O(C)},eventReceive:v(async u=>{const{event:C,draggedEl:R,revert:ee}=u;if(l.readonly||!C.start)return!1;const L=JSON.parse(R.attributes["data-event"].value),G=l.events.find(W=>W.uuid===L.uuid);if(!G)return!1;let V=C.start;if(P.value==="week"){const W=G.isAllDay?{hours:0,minutes:0,seconds:0}:G.startsAtDefaultTime?Rs(G.startsAtDefaultTime):{hours:0,minutes:0,seconds:0};V=ke(V,W)}return await Ne(G,{date:V,direction:"forward",mutateEvent:!0}),!1}),eventDrop:v(async u=>{const{delta:C,event:R,revert:ee}=u;if(l.readonly)return!1;const L=R.extendedProps.event,{startsAt:G,endsAt:V}=L,W=(C.seconds??0)+(C.milliseconds??0)/1e3,ie=L.dateAnchor!=="endsAt"?"forward":"backward";await Ne(L,{date:ke(ie==="forward"?G:V,{seconds:W,minutes:C.minutes??0,hours:C.hours??0,days:C.days??0,months:C.months??0,years:C.years??0}),direction:ie,mutateEvent:!0}),F.value&&(F.value=L)}),slotLabelClassNames({level:u,view:C}){return u===1?"artesa-slot-hour":""}},{calendarDate:_,onChangeDate:({calendar:u})=>{u.scrollToTime("00:00")},currentView:o}),F=B(null);function O(u){F.value=u}const{recalculateOrder:j}=ss({events:b(()=>l.events),groups:b(()=>l.eventGroups)});async function oe(){!F.value||l.readonly||(N(F.value),F.value=null,await j())}function Z(){te.value?A.value.forEach(u=>{u.confirmedAt=null,u.confirmedById=null}):A.value.forEach(u=>{u.confirmedAt||(u.confirmedAt=new Date,u.confirmedById=y.value?.id??null)})}const te=b(()=>A.value.every(u=>!!u.confirmedAt));function N(u){c("remove-event",u)}return Ce(()=>l.active===!1,()=>{F.value=null}),lt(()=>{F.value=null}),E({forceRerender:M}),(u,C)=>{const R=Y,ee=rt,L=J("font-awesome-icon"),G=Qe;return a(),w("div",null,[t("div",Kn,[t("div",Qn,[s(ns,{modelValue:e(_),"onUpdate:modelValue":C[0]||(C[0]=V=>Q(_)?_.value=V:null),size:"default","class-button-today":"hidden md:block",resolution:e(P)},null,8,["modelValue","resolution"])]),s(ee,null,{default:n(()=>[s(R,{disabled:e(P)==="week",size:"default",onClick:C[1]||(C[1]=()=>P.value="week")},{default:n(()=>[I(m(e($)("Days")),1)]),_:1},8,["disabled"]),s(R,{disabled:e(P)==="date",size:"default",onClick:C[2]||(C[2]=()=>P.value="date")},{default:n(()=>[I(m(e($)("Hours")),1)]),_:1},8,["disabled"])]),_:1}),e(F)?(a(),S(G,{key:0,placement:"bottom-end",width:450,visible:"",class:"ml-2","popper-class":"!bg-gray-100","popper-options":{modifiers:[{name:"preventOverflow",options:{altAxis:!0,boundary:"viewport",padding:5}}]}},{reference:n(()=>[s(R,{type:"primary",onClick:C[3]||(C[3]=()=>F.value=null)},{default:n(()=>[s(L,{icon:"pencil-alt",class:"text-xs"})]),_:1})]),default:n(()=>[t("div",Jn,[s(es,{readonly:u.readonly,event:e(F),tasks:u.tasksByEventUuid[e(F).uuid]??[],class:"mb-2"},null,8,["readonly","event","tasks"]),t("div",Xn,[s(R,{type:"danger",plain:"",onClick:oe},{default:n(()=>[s(L,{icon:"trash-alt",class:"text-xs"})]),_:1}),s(R,{class:"px-2",text:"",onClick:C[4]||(C[4]=()=>F.value=null)},{default:n(()=>[I(m(e($)("actions.Close")),1)]),_:1})])])]),_:1})):x("",!0)]),t("div",Yn,[ae(t("div",Zn,[t("div",null,m(e($)("assignmentEvent.Unscheduled"))+":",1),t("div",{ref_key:"refExternalEventsContainer",ref:g},[(a(!0),w(X,null,le(e(i),({event:V,data:W})=>(a(),w("div",{key:V.uuid,class:ne(["drag-resource-event px-2 py-1 m-0.5 !bg-primary text-white rounded-sm cursor-pointer",{"opacity-60":!V.confirmedAt||!!V.completedAt,"line-through":!!V.completedAt}]),"data-event":W,onClick:()=>O(V)},[t("div",null,[V.completedAt?(a(),S(L,{key:0,icon:"check",class:"mr-1 text-xs"})):x("",!0),s(Ae,{value:V},null,8,["value"])]),t("div",sa,[V.workDays<=1?(a(),w(X,{key:0},[I(m(e($)("assignmentEvent.durationTime",{duration:parseFloat((V.workingTimePerDay/3600).toFixed(2))})),1)],64)):(a(),w(X,{key:1},[I(m(e($)("assignmentEvent.durationDaysAndTime",{days:V.workDays,duration:parseFloat((V.workingTimePerDay/3600).toFixed(2))})),1)],64))])],10,ea))),128))],512)],512),[[$e,e(i).length]]),t("div",ta,[e(i).length?(a(),w("span",na,m(e($)("assignmentEvent.Scheduled"))+":",1)):x("",!0),s(e(Kt),{ref_key:"refCalendar",ref:k,class:"flex-1 fc-assignment",options:e(U)},it({eventContent:n(({event:V})=>[t("div",aa,[V.extendedProps.event?(a(),w("div",oa,m(V.extendedProps.timespanFormattedDays),1)):x("",!0)])]),_:2},[u.readonly?void 0:{name:"resourceLabelContent",fn:n(({resource:V})=>[t("div",la,[t("div",{class:ne(["px-1",V.extendedProps.resourceClassNames])},[t("div",ia,[s(R,{text:"",size:"default",disabled:V.extendedProps.assignedEvents.length===0,class:"pt-0 pb-0 w-0 flex-1 !justify-start !font-normal line-clamp-1",onClick:()=>_.value=V.extendedProps.assignedEvents[0].startsAt},{default:n(()=>[I(m(V.title)+" ",1),V.extendedProps.assignedEvents.length?(a(),w("span",ra," ("+m(V.extendedProps.assignedEvents.length)+") ",1)):x("",!0)]),_:2},1032,["disabled","onClick"])])],2)])]),key:"0"}]),1032,["options"]),u.readonly?x("",!0):(a(),w("div",da,[e(A).length?(a(),S(R,{key:0,type:"primary",size:"default",onClick:Z},{default:n(()=>[e(te)?(a(),w("span",ua,m(e($)("assignmentEvent.action.undoConfirmation")),1)):(a(),w("span",ma,m(e($)("assignmentEvent.action.confirmAll")),1))]),_:1})):x("",!0)]))])])])}}}),pa={class:"grid grid-cols-1 md:grid-cols-2 gap-2"},fa={class:"flex gap-1"},ga={class:"el-table"},va={class:"is-leaf el-table__cell"},ya={class:"cell"},ha={class:"is-center is-leaf el-table__cell"},_a={class:"cell"},ka={class:"is-center is-leaf el-table__cell"},ba={class:"cell"},$a={class:"is-center is-leaf el-table__cell"},Ca={class:"cell"},Ea={class:"el-table__cell"},wa={class:"cell"},Aa={class:"el-table__cell is-center"},xa={class:"cell"},Ta={class:"el-table__cell is-center"},Sa={class:"cell"},Ua={class:"el-table__cell is-center"},Va={class:"cell"},Da=K({__name:"TabAnalysis",props:{assignment:{type:Object,required:!0},events:{type:Array,required:!0}},setup(p){const E=p,{t:r}=se(),l=zs(),c=dt({range:"date",date:void 0,users:[],eventTypes:[]}),y=B({startsAt:null,endsAt:null}),$=B(["list"]),g=b(()=>{if(!E.assignment.id)return null;const _={query:{assignmentId:E.assignment.id}};return c.users?.length&&(_.query.userId={$in:c.users.map(i=>i.id)}),c.eventTypes?.length&&(_.query.eventTypeId={$in:c.eventTypes.map(i=>i.id)}),y.value?.startsAt&&(_.query.start={$lt:y.value.endsAt},_.query.$or||=[],_.query.$or.push({end:null},{end:{$gt:y.value.startsAt}})),_});function P(){return{assignmentId:E.assignment.id,companyId:E.assignment.companyId}}const A=B([]);Ye(()=>E.assignment.id,async _=>{if(!_)return;const i=await qs.service("assignment-event-work-periods").adjustedSumForAssignment({assignmentId:_});A.value=i},{immediate:!0});const h=b(()=>E.events.map(i=>{const D=A.value.find(d=>d.eventId===i.id)?.adjustedSum||0,o=i.manPower?D/i.manPower*100:0;return{event:i,manPower:i.manPower??0,booked:D,percentage:o,percentageToDisplay:o>1e4?"10000+%":`${o.toFixed(0)}%`}}));return(_,i)=>{const D=Y,o=ut,d=mt,v=ct,k=pt,U=ft,M=gt,F=vt;return a(),S(F,{modelValue:e($),"onUpdate:modelValue":i[7]||(i[7]=O=>Q($)?$.value=O:null)},{default:n(()=>[s(M,{title:e(r)("assignment.analysis.list"),name:"list"},{default:n(()=>[s(U,{"label-width":"105px","label-position":e(l).xs?"left":"top"},{default:n(()=>[t("div",pa,[s(k,{label:e(r)("Date")+":"},{default:n(()=>[t("div",fa,[s(v,null,{dropdown:n(()=>[s(d,null,{default:n(()=>[s(o,{disabled:e(c).range==="date",onClick:i[0]||(i[0]=()=>e(c).range="date")},{default:n(()=>[I(m(e(r)("Day")),1)]),_:1},8,["disabled"]),s(o,{disabled:e(c).range==="week",onClick:i[1]||(i[1]=()=>e(c).range="week")},{default:n(()=>[I(m(e(r)("Week")),1)]),_:1},8,["disabled"]),s(o,{disabled:e(c).range==="month",onClick:i[2]||(i[2]=()=>e(c).range="month")},{default:n(()=>[I(m(e(r)("Month")),1)]),_:1},8,["disabled"])]),_:1})]),default:n(()=>[s(D,null,{default:n(()=>[I(m(e(r)(e(c).range==="date"?"Day":e(c).range==="week"?"Week":"Month")),1)]),_:1})]),_:1}),s(ns,{modelValue:e(c).date,"onUpdate:modelValue":i[3]||(i[3]=O=>e(c).date=O),resolution:e(c).range,"disabled-date":O=>O.getTime()>Date.now(),"hide-button-today":"",clearable:"",onInterval:i[4]||(i[4]=O=>y.value=O)},null,8,["modelValue","resolution","disabled-date"])])]),_:1},8,["label"]),s(k,{label:`${e(r)("Employee")}:`},{default:n(()=>[s(Qt,{modelValue:e(c).users,"onUpdate:modelValue":i[5]||(i[5]=O=>e(c).users=O),clearable:"",class:"w-full",multi:!0,"collapse-tags":""},null,8,["modelValue"])]),_:1},8,["label"]),s(k,{label:`${e(r)("assignmentEvent.name")}:`},{default:n(()=>[s(Jt,{modelValue:e(c).eventTypes,"onUpdate:modelValue":i[6]||(i[6]=O=>e(c).eventTypes=O),multi:!0,"collapse-tags":"","show-select-all":"","clear-on-select-all":"",clearable:"",class:"w-full"},null,8,["modelValue"])]),_:1},8,["label"])])]),_:1},8,["label-position"]),s(Xt,{params:e(g),"allow-assignment-edit":!1,"create-data":P,"csv-name-append":`-${e(r)("assignment.name",1)}-${E.assignment.number||E.assignment.name}`,"hide-project-in-table":"","hide-assignment-in-table":""},null,8,["params","csv-name-append"])]),_:1},8,["title"]),s(M,{title:e(r)("assignment.analysis.calculation"),name:"nominal-actual"},{default:n(()=>[t("table",ga,[t("thead",null,[t("tr",null,[t("th",va,[t("div",ya,m(e(r)("assignmentEvent.name",1)),1)]),t("th",ha,[t("div",_a,m(e(r)("assignment.analysis.estimatedManPower")),1)]),t("th",ka,[t("div",ba,m(e(r)("assignment.analysis.bookedManPower")),1)]),t("th",$a,[t("div",Ca,m(e(r)("Percentage")),1)])])]),t("tbody",null,[(a(!0),w(X,null,le(e(h),({event:O,booked:j,manPower:oe,percentageToDisplay:Z})=>(a(),w("tr",{key:O.uuid,class:"el-table__row"},[t("td",Ea,[t("div",wa,[s(Ae,{value:O,"line-through-on-completed":""},null,8,["value"])])]),t("td",Aa,[t("div",xa,m(e(Re)(oe,{hours:"always",minutes:"always"}).result)+" "+m(e(r)("hoursShort")),1)]),t("td",Ta,[t("div",Sa,m(e(Re)(j,{hours:"always",minutes:"always"}).result)+" "+m(e(r)("hoursShort")),1)]),t("td",Ua,[t("div",Va,m(Z),1)])]))),128))])])]),_:1},8,["title"])]),_:1},8,["modelValue"])}}}),Pa={key:0,class:"ml-2"},Ia={class:"flex-1 flex flex-row gap-2 justify-end"},ja={key:1},Ba={key:2},Fa=K({__name:"DetailedAssignmentButtons",props:{assignment:{type:Object,required:!0},hasChanges:{type:Boolean,default:!1},cloningInProgress:{type:Boolean,default:!1},isSavePending:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1},hideDelete:{type:Boolean,default:!1}},emits:["clicked-delete","clicked-cancel","clicked-save"],setup(p){const E=B(),{cq:r}=as(E),{can:l}=Ze();return(c,y)=>{const $=J("font-awesome-icon"),g=Y;return a(),w("div",{ref_key:"container",ref:E,class:"flex justify-between flex-wrap gap-3"},[e(l)("remove",p.assignment)&&!p.readonly&&!p.hideDelete?(a(),S(g,{key:0,type:"danger",plain:"",onClick:y[0]||(y[0]=()=>c.$emit("clicked-delete"))},{default:n(()=>[s($,{icon:"trash-alt",class:"text-xs"}),e(r).md?(a(),w("span",Pa,m(c.$t("actions.Delete")),1)):x("",!0)]),_:1})):x("",!0),t("div",Ia,[p.hasChanges?(a(),S(g,{key:0,text:!p.hasChanges,plain:"",type:p.hasChanges?"warning":void 0,onClick:y[1]||(y[1]=()=>c.$emit("clicked-cancel"))},{default:n(()=>[I(m(c.$t("actions.Cancel")),1)]),_:1},8,["text","type"])):x("",!0),s(g,{type:"primary",loading:p.isSavePending,onClick:y[2]||(y[2]=()=>p.hasChanges?c.$emit("clicked-save"):c.$emit("clicked-cancel"))},{default:n(()=>[p.hasChanges?(a(),S($,{key:0,icon:"check",class:"mr-2 text-xs"})):x("",!0),e(l)("patch",p.assignment)&&p.hasChanges&&!p.readonly?(a(),w("span",ja,m(c.$t("actions.Save")),1)):(a(),w("span",Ba,m(c.$t("actions.Close")),1))]),_:1},8,["loading"])])],512)}}}),Oa=K({__name:"TabFiles",props:{assignment:{}},setup(p){return(E,r)=>(a(),S(Ut,{"assignment-id":E.assignment.id,"company-id":E.assignment.companyId,"events-local":!0},null,8,["assignment-id","company-id"]))}}),Ra={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"},za=t("path",{fill:"currentColor",d:"M6 8a1 1 0 0 0 0 2h4a1 1 0 1 0 0-2zm5 4a1 1 0 0 1 1-1h4a1 1 0 1 1 0 2h-4a1 1 0 0 1-1-1m4 2a1 1 0 1 0 0 2h3a1 1 0 1 0 0-2zM5.25 4A3.25 3.25 0 0 0 2 7.25v9.5A3.25 3.25 0 0 0 5.25 20h13.5A3.25 3.25 0 0 0 22 16.75v-9.5A3.25 3.25 0 0 0 18.75 4zM8 5.5V7h1.5V5.5h5V10H16V5.5h2.75c.966 0 1.75.784 1.75 1.75v9.5a1.75 1.75 0 0 1-1.75 1.75H16V17h-1q-.26 0-.5-.063V18.5h-5V11H8v7.5H5.25a1.75 1.75 0 0 1-1.75-1.75v-9.5c0-.966.784-1.75 1.75-1.75z"},null,-1),qa=[za];function Ma(p,E){return a(),w("svg",Ra,qa)}const Na={name:"fluent-gantt-chart-24-regular",render:Ma},Ga={class:"font-light text-slate-500"},La={class:"mb-2"},Ha={class:"text-lg"},Wa={class:"text-lg"},Ka={class:"dialog-footer flex justify-end flex-wrap gap-1"},Qa={class:"dialog-footer flex justify-end flex-wrap gap-1"},Ja=K({__name:"DetailedAssignment",props:{assignment:{}},emits:["discarded","deleted","saved"],setup(p,{expose:E,emit:r}){const l=p,c=r,y=B(),$=B(),{t:g}=se(),{cq:P}=as($),A=b(()=>!P.value.xl),{can:h}=Ze(),_=B("assignment");Ye(_,async f=>{f==="gantt"&&(await _e(),y.value?.forceRerender())});const i=Ge("craft"),D=B(!1),o=B(!1),d=B(!1),v=B(!1),k=Ke().createScope(),U=Ms().createScope(),M=Ns().createScope(),F=Gs().createScope(),O=Ls().createScope(),j=Hs().createScope(),oe=Ws().createScope(),Z=Ks().createScope(),te=Vt(),{data:N,markForRemove:u,save:C,reset:R,haveLoaded:ee,hasChanges:L}=F.useFeathersItems({params:b(()=>({query:{assignmentUuid:l.assignment.uuid,$sort:{order:1}}})),fetchParams:b(()=>l.assignment.id?{query:{assignmentId:l.assignment.id,$limit:-1}}:null)}),G=B(0),V=b({get(){return N.value[G.value]},set(f){G.value=N.value.findIndex(T=>T.uuid===f.uuid)}}),{data:W,markForRemove:ie,save:ls,reset:is,haveLoaded:eo,hasChanges:rs}=O.useFeathersItems({params:b(()=>({query:{assignmentUuid:l.assignment.uuid,$sort:{order:1}}})),fetchParams:b(()=>l.assignment.id?{query:{assignmentId:l.assignment.id,$limit:-1}}:null)});function ds(f,T){f&&ie(f),u(T)}const{data:us,save:ms,reset:cs,hasChanges:ps}=j.useFindOnce({items:b(()=>N.value.map(f=>f.id)),params:b(()=>N.value.length?{query:{eventUuid:{$in:N.value.map(T=>T.uuid)},$sort:{order:1}}}:null),fetchParams:f=>(f=f.filter(be),{query:{eventId:{$in:f},$sort:{order:1},$limit:-1}})}),{data:so,save:fs,reset:gs,hasChanges:vs}=oe.useFindOnce({items:b(()=>N.value.map(f=>f.id)),params:b(()=>N.value.length?{query:{eventUuid:{$in:N.value.map(T=>T.uuid)},$sort:{order:1}}}:null),fetchParams:f=>(f=f.filter(be),{query:{eventId:{$in:f},$sort:{order:1}}})}),{hasTemplates:ys,customForms:xe,hasChanges:hs,save:_s,reset:ks}=Dt({companyId:()=>l.assignment.companyId,associatedParentServicePath:"assignments",associatedParentId:()=>l.assignment.id}),Te=Qs().createScope(),{serverCount:Se}=Te.useCount({params:b(()=>l.assignment.id?{query:{associatedParentId:l.assignment.id,associatedParentServicePath:"stairs"}}:null)}),{hasChanges:bs,reset:$s,save:Cs}=Te.useFeathersItems({localOnly:!0,params:b(()=>l.assignment.id?{query:{associatedParentId:l.assignment.id,associatedParentServicePath:"stairs",$limit:-1}}:null)});let fe=null,Ue=null,Ve=!1,ge=!1,De=!1;const{saveTags:Es,resetTags:ws,tagsHaveChanges:As}=os({assignment:()=>l.assignment}),ve=b(()=>k.hasChanges(l.assignment)||U.hasChanges(l.assignment.customer)||M.hasChanges(l.assignment.addressProperty)||M.hasChanges(l.assignment.customer?.address)||Z.hasChanges(l.assignment.project)||L.value||rs.value||ps.value||vs.value||As.value||Us.value||bs.value||te.postponeTimeHasCome||hs.value);async function re(f){const{force:T=!1,skipEmit:H=!1}=f??{};return T||!ve.value||Ve||De?(T&&de(),ge=!0,H||c("discarded"),!0):(Ue=new Promise(z=>{fe=z}),o.value=!0,await Ue?(D.value=!1,de(),H||c("discarded"),ge=!0,!0):!1)}yt(async()=>ge?!0:await re({skipEmit:!0}));function de(){k.reset(l.assignment),U.reset(l.assignment.customer),M.reset(l.assignment.addressProperty),M.reset(l.assignment.customer?.address),Z.reset(l.assignment.project),cs(),gs(),R(),is(),ws(),Vs(),$s(),te.reset(),ks()}async function Pe(){try{if(v.value=!0,!h("patch",l.assignment)){de();return}await Promise.all([ls(),M.save(l.assignment.customer?.address??void 0),M.save(l.assignment.addressProperty??void 0),Z.save(l.assignment.project??void 0)]),await Promise.all([C(),Es()]),await Promise.all([ms(),fs(),Ds(),Cs(),_s(),U.save(l.assignment.customer??void 0)]),await k.save(l.assignment),await _e(),await te.savePostponedUploads(),Ve=!0,c("saved")}finally{v.value=!1}}const ye=B(!1);async function xs(){try{ye.value=!0,await k.remove(l.assignment)}finally{ye.value=!1}De=!0,c("deleted")}const Ts=Js().createScope(),{data:Ie,markForRemove:Ss,hasChanges:Us,reset:Vs,save:Ds}=Ts.useFeathersItems({params:b(()=>({query:{assignmentUuid:l.assignment.uuid,$limit:-1,$sort:{order:1}}})),fetchParams:b(()=>l.assignment.id?{query:{assignmentId:l.assignment.id,$limit:-1,$sort:{order:1}}}:null)}),ue=b(()=>Zt(Ie.value,"eventUuid"));async function je(f){const{event:T}=f;if(Ss(f),!T)return;await _e(),Ie.value.filter(z=>z.eventUuid===T.uuid).forEach((z,me)=>{const ce=me+1;z.order!==ce&&(z.order=ce)})}const Ps=Ge(["admin","superadmin"]),Be=b(()=>{const f={assignment:l.assignment,customer:l.assignment.customer,address:l.assignment.addressProperty};if(!Object.values(f).some(T=>T===void 0))return f});return E({hasChanges:ve,save:Pe,reset:de,discard:re}),(f,T)=>{const H=J("font-awesome-icon"),z=ht,me=_t,ce=kt,pe=Y,Fe=Ee;return a(),w("div",{ref_key:"refContainer",ref:$},[s(ce,{modelValue:e(_),"onUpdate:modelValue":T[3]||(T[3]=q=>Q(_)?_.value=q:null),type:"card"},{default:n(()=>[s(z,{name:"assignment",lazy:""},{label:n(()=>[t("span",null,[s(H,{icon:"clipboard-list",class:"text-sm mr-1"}),I(" "+m(e(g)("DetailedAssignment.tab.general")),1)])]),default:n(()=>[s(Ln,{assignment:f.assignment,events:e(N),"event-groups":e(W),"event-users":e(us),"tasks-by-event-uuid":e(ue),"hide-chat":e(A),readonly:e(i)},null,8,["assignment","events","event-groups","event-users","tasks-by-event-uuid","hide-chat","readonly"])]),_:1}),e(i)?x("",!0):(a(),S(z,{key:0,name:"events-table",lazy:""},{label:n(()=>[t("span",null,[s(H,{icon:"tasks",class:"text-sm mr-1"}),I(" "+m(e(g)("assignmentEvent.name",2)),1)])]),default:n(()=>[s(xt,{assignment:f.assignment,events:e(N),"event-groups":e(W),"tasks-by-event-uuid":e(ue),class:"max-w-7xl mx-auto",onRemoveEvent:e(u),onRemoveGroup:ds,onRemoveTask:je},null,8,["assignment","events","event-groups","tasks-by-event-uuid","onRemoveEvent"])]),_:1})),e(A)?(a(),S(z,{key:1,name:"chat",lazy:""},{label:n(()=>[t("span",null,[s(H,{icon:["far","comments"],class:"text-sm mr-1"}),t("span",null,m(e(g)("chat.chat")),1)])]),default:n(()=>[s(Wn,{assignment:f.assignment},null,8,["assignment"])]),_:1})):x("",!0),s(z,{name:"files",lazy:""},{label:n(()=>[s(H,{icon:["far","folder-open"],class:"mr-1"}),t("span",null,[I(m(e(g)("file",2))+" ",1),t("span",Ga,m(e(Se)?` (${e(Se)})`:""),1)])]),default:n(()=>[s(Oa,{assignment:f.assignment},null,8,["assignment"])]),_:1}),e(ys)||e(xe).length>0?(a(),S(z,{key:2,name:"custom-form",lazy:""},{label:n(()=>[s(H,{icon:"file-invoice",class:"text-sm mr-1"}),t("span",null,m(e(g)("customForms.name",2)),1)]),default:n(()=>[e(Be)?(a(),S(Yt,{key:0,"custom-forms":e(xe),"form-type":"ASSIGNMENT","company-id":f.assignment.companyId,"associated-service-path":"assignments","associated-id":f.assignment.id,"associated-parent-service-path":"assignments","associated-parent-id":f.assignment.id,context:e(Be),location:"detailedAssignment"},null,8,["custom-forms","company-id","associated-id","associated-parent-id","context"])):x("",!0)]),_:1})):x("",!0),s(z,{name:"gantt",lazy:""},{label:n(()=>[t("span",null,[s(e(Na),{class:"inline mr-1"}),t("span",null,m(e(g)("assignment.process")),1)])]),default:n(()=>[s(ca,{ref_key:"refGantt",ref:y,assignment:f.assignment,events:e(N),"event-groups":e(W),active:e(_)==="gantt",readonly:e(i),"tasks-by-event-uuid":e(ue),onRemoveEvent:e(u)},null,8,["assignment","events","event-groups","active","readonly","tasks-by-event-uuid","onRemoveEvent"])]),_:1}),s(z,{name:"notes",lazy:""},{label:n(()=>[t("span",null,[ae(t("span",null,[s(H,{icon:"exclamation-circle",class:"text-sm mr-1 text-danger"})],512),[[$e,!!f.assignment.comment||!!f.assignment.notesBackOffice]]),t("span",null,m(e(g)("assignmentEvent.annotations")),1)])]),default:n(()=>[t("div",null,[t("div",La,[t("label",Ha,m(e(g)("assignment.notesForEmployee"))+":",1),s(me,{modelValue:f.assignment.comment,"onUpdate:modelValue":T[0]||(T[0]=q=>f.assignment.comment=q),rows:7,readonly:!f.$can("update",f.assignment,"comment")||e(i),disabled:!f.$can("update",f.assignment,"comment")||e(i),type:"textarea",placeholder:e(g)("assignment.notes")},null,8,["modelValue","readonly","disabled","placeholder"])]),t("div",null,[t("label",Wa,m(e(g)("assignment.notesForTheOffice"))+":",1),s(me,{modelValue:f.assignment.notesBackOffice,"onUpdate:modelValue":T[1]||(T[1]=q=>f.assignment.notesBackOffice=q),rows:7,readonly:!f.$can("update",f.assignment,"notesBackOffice")||e(i),disabled:!f.$can("update",f.assignment,"notesBackOffice")||e(i),type:"textarea",placeholder:e(g)("assignment.officeNotes")},null,8,["modelValue","readonly","disabled","placeholder"])])])]),_:1}),e(V)?(a(),S(z,{key:3,name:"tracking",lazy:""},{label:n(()=>[s(H,{icon:"clipboard-list",class:"text-sm mr-1"}),t("span",null,m(e(g)("Doing.name")),1)]),default:n(()=>[s(Pt,{event:e(V),"onUpdate:event":T[2]||(T[2]=q=>Q(V)?V.value=q:null),tasks:e(ue)[e(V).uuid]??[],local:"",onRemoveTask:je},null,8,["event","tasks"])]),_:1})):x("",!0),e(Ps)?(a(),S(z,{key:4,name:"analysis",lazy:""},{label:n(()=>[s(H,{icon:"search-plus",class:"text-sm mr-1"}),t("span",null,m(e(g)("assignment.Analysis")),1)]),default:n(()=>[s(Da,{assignment:f.assignment,events:e(N)},null,8,["assignment","events"])]),_:1})):x("",!0)]),_:1},8,["modelValue"]),s(Fa,{assignment:f.assignment,"is-save-pending":e(v),"has-changes":e(ve),"cloning-in-progress":e(d),readonly:e(i),"hide-delete":e(_)!=="assignment",class:"mt-3",onClickedSave:Pe,onClickedCancel:re,onClickedDelete:T[4]||(T[4]=q=>D.value=!0)},null,8,["assignment","is-save-pending","has-changes","cloning-in-progress","readonly","hide-delete"]),e(D)?(a(),S(Fe,{key:0,modelValue:e(D),"onUpdate:modelValue":T[7]||(T[7]=q=>Q(D)?D.value=q:null),title:e(g)("assignment.deleteAssignment")+"?","append-to-body":"",class:"dialog-messagebox-[600px] dialog-center"},{footer:n(()=>[t("span",Ka,[s(pe,{text:"",onClick:T[5]||(T[5]=q=>D.value=!1)},{default:n(()=>[I(m(f.$t("actions.Cancel")),1)]),_:1}),s(pe,{type:"danger",loading:e(ye),onClick:T[6]||(T[6]=q=>xs())},{default:n(()=>[s(H,{icon:"trash-alt",class:"mr-2 text-xs"}),I(" "+m(e(g)("assignment.deleteAssignment")),1)]),_:1},8,["loading"])])]),default:n(()=>[t("span",null,m(e(g)("assignment.deleteWarning")),1)]),_:1},8,["modelValue","title"])):x("",!0),e(o)?(a(),S(Fe,{key:1,modelValue:e(o),"onUpdate:modelValue":T[10]||(T[10]=q=>Q(o)?o.value=q:null),title:e(g)("discard.discardChanges")+"?","append-to-body":"",class:"dialog-messagebox-[600px] dialog-center"},{footer:n(()=>[t("span",Qa,[s(pe,{text:"",onClick:T[8]||(T[8]=q=>(o.value=!1,e(fe)&&e(fe)(!1)))},{default:n(()=>[I(m(e(g)("discard.continueEdit")),1)]),_:1}),s(pe,{type:"warning",plain:"",onClick:T[9]||(T[9]=q=>(o.value=!1,re({force:!0})))},{default:n(()=>[I(m(e(g)("discard.discardChanges")),1)]),_:1})])]),default:n(()=>[t("span",null,m(e(g)("discard.discardChangesMessage")),1)]),_:1},8,["modelValue","title"])):x("",!0)],512)}}}),Xa={class:"dialog-title"},Ya={key:0},Za={key:1,style:{height:"100px"}},Do=K({__name:"DialogDetailedAssignment",props:{assignmentId:{type:Number,required:!0},goToName:{type:String,default:null},dontUseRouter:{type:Boolean,default:!1}},emits:["close"],setup(p,{emit:E}){const r=p,l=E,c=Je(),y=Xs(),$=Ys(),g=b(()=>y.isLightBoxOpen||$.isOpen),P=Ke().createScope(),{data:A,isPending:h}=P.useGet({id:()=>r.assignmentId,fetchParams:b(()=>({$populateParams:{name:"assignmentDetailed"}}))});en("stairs","removed",v=>{v.id===r.assignmentId&&o()});const _=b(()=>{const v=[];return A.value?.number&&v.push(A.value.number),A.value?.name&&v.push(A.value.name),v.join(" - ")}),i=Is({keepQuery:!0});let D=!1;function o(){D=!0,r.dontUseRouter?l("close"):i()}async function d(v){(await c.value?.discard({skipEmit:D})??!0)&&v()}return(v,k)=>{const U=Ee,M=we;return a(),S(U,{"model-value":!!p.assignmentId,class:"dialog-messagebox-[1800px]","append-to-body":"","close-on-press-escape":!e(g),"before-close":d},{header:n(()=>[t("div",Xa,[e(A)?(a(),w("div",Ya,[t("span",null,m(e(_)),1)])):x("",!0)])]),default:n(()=>[e(A)?(a(),S(Ja,{key:0,ref_key:"refDetailedAssignment",ref:c,assignment:e(A),onDiscarded:k[0]||(k[0]=()=>o()),onSaved:k[1]||(k[1]=()=>o()),onDeleted:k[2]||(k[2]=()=>o())},null,8,["assignment"])):ae((a(),w("div",Za,null,512)),[[M,e(h)]])]),_:1},8,["model-value","close-on-press-escape"])}}});export{Do as _};
