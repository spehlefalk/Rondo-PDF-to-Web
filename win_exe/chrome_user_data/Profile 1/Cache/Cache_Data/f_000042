import{fh as ge,aP as he,fq as wt,eY as bt,r as P,V as G,M as xt,W as kt,Z as o,a as ee,u as ye,b as _e,o as a,aC as I,g as U,e5 as V,c as e,h,i as L,t as E,j as S,eh as re,ei as ve,aj as j,e6 as X,e as T,f as y,l as we,eO as It,el as Re,aQ as Ne,em as At,Y as Ut,k as K,aS as Pe,e0 as je,fd as Ve,aR as Fe,x as Tt,ec as ze,s as te,N as St,fw as Et,eo as Me,$ as $t,fx as qe,ag as Dt,eg as Ct,w as Nt,aE as Pt,ep as Vt,eq as Ft,e1 as Mt,e2 as qt,fy as Bt,m as Wt,eJ as Lt,ah as fe,er as Rt}from"./vendor-CJXdOFCa.js";import{a as Q}from"./ArtesaTimePickerForCalendar.vue_vue_type_style_index_0_lang-BBYnsASy.js";import{ag as jt,ah as be,G as Oe,C as Ge,d as zt,V as Be,h as Ot,ai as Gt,aj as Ht,ak as Yt,al as Jt,w as Zt,u as Kt,e as Qt,t as Xt,J as es,D as ts,a as ss,v as ns}from"./index-M8nwXBBi.js";import{_ as as}from"./TimeTrackingPanel.vue_vue_type_script_setup_true_lang-D5RdRkNm.js";import{_ as rs}from"./DialogDoingAssignmentCard.vue_vue_type_style_index_0_lang-DPVHlSeg.js";import{u as He,_ as os}from"./manufacturing.store-zPgEPTe7.js";import{a as Ye,b as We,c as is,u as ls,d as us}from"./timeTracking.store-CFdMaox0.js";import{g as xe,u as ds}from"./useAssignmentNameToShow-CT9dDVHV.js";import{a as oe}from"./index-B3z-Az2g.js";import{i as cs}from"./index-D4alReEY.js";import{G as ms}from"./index-DX0mSCHG.js";import{m as Le}from"./addLiteralPercentage-DRqvLqOk.js";import{u as fs}from"./useAssignmentEventTypesForUser-Dx0eHJg-.js";import{u as pe}from"./useCompanySettingValue-DJ6odCGL.js";import{_ as ps}from"./SelectUser.vue_vue_type_script_setup_true_lang-81euLzTY.js";import"./index-zBlMUfmj.js";import"./index-CgnmzLwJ.js";import"./ArtesaTimeInput.vue_vue_type_style_index_0_lang-CQRpcmmu.js";import"./index-BCyjfQC_.js";import"./index-BcEzXG89.js";import"./shared-DBN7Ac9_.js";import"./index-vAnxXWJT.js";import"./InputWrapperGroup.vue_vue_type_script_setup_true_lang-rA6cWmcO.js";import"./ArtesaTooltip-CzaCLuSr.js";import"./index.browser-DP16PUbO.js";import"./users.helpers-iK3u8JSc.js";import"./user-absences.helpers-C55N6n0p.js";import"./colorHelpers-D-IKRuV7.js";import"./index-C4Rzlq_k.js";import"./GridTableColumn.vue_vue_type_script_setup_true_lang-BayDfMSt.js";import"./useIsUserOfRole-BciEmr9Y.js";import"./useRole-B2COsB3X.js";import"./FeathersTablePagination.vue_vue_type_style_index_0_lang-DDfA-nHC.js";import"./MakeSortable.vue_vue_type_script_setup_true_lang-DJUGCLh6.js";import"./usePagination-Cs_oXynH.js";import"./hasItemsForCompany.store-D65GIO8M.js";import"./validateFormAsync-7W-wrk_Q.js";import"./index-CbtekCeJ.js";import"./index-CsgZOv_I.js";import"./useFullcalendar-CGsOBmOU.js";import"./AssignmentEventWorkPeriodForm.vue_vue_type_script_setup_true_lang-G9iZDIwp.js";import"./SelectAssignment.vue_vue_type_script_setup_true_lang-Cxd5Ad6L.js";import"./FeathersSelectAutocomplete.vue_vue_type_style_index_0_lang-D553730i.js";import"./SelectAssignmentEvent.vue_vue_type_script_setup_true_lang-C9q4G1aL.js";import"./assignment-events.helpers-DEIAJbEv.js";import"./AssignmentEventName.vue_vue_type_script_setup_true_lang-BrVc5Ffk.js";import"./ArtesaDatePicker.vue_vue_type_style_index_0_lang-CcrFwhau.js";import"./useContainerQuery-odtNFs_8.js";import"./UnaccountablePeriodForm.vue_vue_type_script_setup_true_lang-DR3Oxmhb.js";import"./SelectAssignmentEventType.vue_vue_type_script_setup_true_lang-D-40_Wby.js";import"./ElTextareaAutosize.vue_vue_type_script_setup_true_lang-D7GYU17H.js";import"./ViewTitle.vue_vue_type_script_setup_true_lang-jbaBK0gh.js";import"./PopperSelectUserSingle.vue_vue_type_script_setup_true_lang-mBOovX6F.js";import"./ArtesaProfilePicture.vue_vue_type_script_setup_true_lang-CvX_tVhj.js";import"./PopperFeathersItems.vue_vue_type_script_setup_true_lang-hljKYvsA.js";import"./floating-vue-FD3sxU32.js";import"./useIdObjectMapper-DMCCNls8.js";import"./useCSVStringify-B_CNzhVJ.js";import"./useCustomForms-BO40DnxB.js";import"./upload.store-BC_PBlNG.js";import"./AddressMap.vue_vue_type_script_setup_true_lang-DupxI1iS.js";import"./user-capabilities.store-CT1KSZFU.js";import"./addresses.helpers-58tAVzey.js";import"./customers.helpers-B4XzAe7u.js";import"./ButtonAddressNavigation.vue_vue_type_script_setup_true_lang-BYrurNls.js";function vs(x){return ge(1,arguments),he(x,oe(Date.now(),1))}function gs(x,u){ge(2,arguments);var m=wt(u);return oe(x,-m)}function hs(x){return ge(1,arguments),he(x,gs(Date.now(),1))}function ys(x){const u=x.time??30,m=x.updateInterval??1e3,{idle:p,lastActive:_}=bt(u*1e3),d=P(u);let w=null;G(p,i=>{i?f():c()});function c(){d.value=u,w&&(clearInterval(w),w=null),w=setInterval(()=>{if(d.value<m){f();return}d.value=d.value-m},m)}function f(){w&&(clearInterval(w),w=null),d.value=0}return xt(()=>{f()}),c(),{idle:p,lastActive:_,remainingTime:d}}function _s(x){const u=kt(x.ids),m=jt(x.store),p=P([]);return G(u,d=>{if(!d.length)return;const w=[];d.forEach(c=>{!m.localFind(c)&&!p.value.includes(c)&&w.push(c)}),w.length&&(m.find({query:{id:{$in:w},$limit:w.length}}),p.value=[...p.value,...w])}),{items:o(()=>{const d=[],w=m.findInStore({query:{id:{$in:u.value}}});return u.value.forEach(c=>{const f=w.find(i=>i.id===c);f&&d.push(f)}),d})}}const ws={key:0,class:"text-xs ml-2 md:ml-0 md:mt-2"},bs={key:1,class:"w-0 flex-1"},xs={class:"truncate"},ks={key:0,class:"text-xs font-normal mt-1"},Is={key:1,class:"text-xs font-normal mt-1"},As={class:"text-xs mt-2"},Us=ee({__name:"WorkerCard",props:{user:{},workPeriods:{},eventUsers:{default:void 0},assignmentNameToShow:{default:be[0]}},emits:["click-event"],setup(x){const u=x,{t:m}=ye(),p=P(!1),_=P(null),d=He(),w=Oe().createScope(),{unaccountablePeriods:c,hasUnaccountablePeriods:f}=Ye({user:()=>u.user,local:!0}),i=o(()=>!d.isUserActive||!d.activeUser||d.activeUser.id!==u.user.id);function F(s){d.isSupervisor&&d.setActiveUser(s)}function M(){p.value=!p.value}function N(s){if(_.value){_.value=null,M();return}_.value=setTimeout(()=>{const r=!_.value;_.value=null,!r&&F(s)},150)}const C=o(()=>[...new Set([...(u.eventUsers??[]).map(s=>s.eventId),...u.workPeriods.map(s=>s.eventId)])].filter(Ge)),{items:R}=_s({store:w,ids:C}),l=o(()=>{const s={};return C.value.forEach(r=>{s[r]={eventUsers:[],workPeriods:[],activeWorkPeriods:[],pausedWorkPeriods:[]}}),u.eventUsers?.forEach(r=>{s[r.eventId].eventUsers.push(r)}),u.workPeriods.forEach(r=>{r.eventId&&(s[r.eventId].workPeriods.push(r),r.end||s[r.eventId].activeWorkPeriods.push(r),r.pausedAt&&s[r.eventId].pausedWorkPeriods.push(r))}),s}),v=o(()=>{const s={};return u.workPeriods.forEach(r=>{r.end||!r.eventId||(s[r.eventId]||(s[r.eventId]=[]),s[r.eventId].push(r))}),s});return(s,r)=>{const k=_e("font-awesome-icon"),B=we;return a(),I("div",{class:V(["worker-card flex flex-col md:flex-row mb-2 border-2 rounded transition-all",{"bg-red-600 border-red-600 shadow":!e(i),"bg-red-300 opacity-80 text-gray-450 border-red-300":e(i)}])},[U("div",{class:V(["flex w-full md:w-28 text-white transition-all",{"flex-row flex-1":e(p),"flex-row md:flex-col":!e(p),"opacity-50":e(i),"bg-red-600":!e(i)}])},[U("div",{class:V(["self-start text-gray-800 cursor-pointer m-1 py-1 px-2 transition-all",{"bg-white":!e(i),"bg-slate-100":e(i)}]),onClick:r[0]||(r[0]=g=>p.value=!e(p))},[h(k,{icon:e(p)?"angle-down":"angle-up","fixed-width":""},null,8,["icon"])],2),U("div",{class:V(["flex flex-1 justify-center items-center text-center py-2 px-1 flex-row md:flex-col",{"cursor-pointer":e(d).isSupervisor&&s.user!==e(d).activeUser}]),onClick:r[1]||(r[1]=g=>N(s.user))},[L(E(s.user.fullName)+" ",1),s.user.shortName?(a(),I("div",ws,"("+E(s.user.shortName)+")",1)):S("",!0)],2)],2),re(U("div",{class:V(["flex flex-1 flex-wrap gap-1 p-2",{"bg-white":!e(i),"bg-slate-100":e(i),"max-md:rounded-b-sm md:rounded-r-sm":!e(f)}])},[(a(!0),I(j,null,X(e(R),g=>re((a(),T(B,{key:g.uuid,disabled:e(i),class:"w-[170px] !h-12 text-lg !p-1 !flex !items-stretch [&>span]:!flex [&>span]:!flex-1 [&>span]:!overflow-hidden",type:e(l)[g.id].workPeriods.length?"danger":void 0,onClick:()=>s.$emit("click-event",g)},{default:y(()=>[g?.completedAt?(a(),T(k,{key:0,icon:"check",class:"text-xs flex-none mx-2"})):S("",!0),g.assignment?(a(),I("div",bs,[U("div",xs,E(e(xe)(g.assignment,s.assignmentNameToShow)),1),e(l)[g.id].activeWorkPeriods.length?(a(),I("div",ks,E(e(m)("tracking.time.checkedInSince",{since:e(We)(e(v)[g.id][0].start).value})),1)):e(l)[g.id].pausedWorkPeriods.length?(a(),I("div",Is,E(e(m)("paused")),1)):S("",!0)])):S("",!0)]),_:2},1032,["disabled","type","onClick"])),[[ve,!e(p)&&g]])),128))],2),[[ve,!e(p)]]),e(c).length>0&&!e(p)?(a(),I("div",{key:0,class:V(["flex items-center justify-center p-1 max-md:border-t md:border-l max-md:rounded-b-sm md:rounded-r-sm",{"bg-white border-red-600":!e(i),"bg-slate-100 border-red-300":e(i)}])},[(a(!0),I(j,null,X(e(c),g=>(a(),T(B,{key:g.uuid,disabled:"",type:"warning",class:"min-w-[170px] !h-12 text-lg p-2 [&>span]:flex [&>span]:flex-col"},{default:y(()=>[L(E(g.type?.name)+" ",1),U("div",As,E(e(m)("tracking.time.checkedInSince",{since:e(We)(g.start).value})),1)]),_:2},1024))),128))],2)):S("",!0)],2)}}}),Ts={class:"flex-1 flex w-0 justify-center items-center"},Ss={class:"truncate px-1"},Es={key:0,class:"truncate text-xs mt-1 px-1"},$s={class:"flex justify-center items-center py-1 pr-1"},Ds=ee({__name:"AssignmentButton",props:{event:{},disabled:{type:Boolean,default:!1},eventUsers:{default:()=>[]},assignmentNameToShow:{default:be[0]}},emits:["click","update:isDialogVisible"],setup(x,{emit:u}){const m=x,p=u,_=o(()=>({assignmentId:m.event.assignmentId})),d=zt(),{hasUnreadMessages:w}=d.useHasUnreadChatMessages(_),c=o(()=>{const{endsAt:s}=m.event;return s?Be(s,"dd."):null}),f=o(()=>{const{endsAt:s}=m.event;return s?Be(s,"MM."):null}),i=It({interval:1e3*60*30}),F=o(()=>{const{endsAt:s}=m.event;return s?he(s,i.value):!1}),M=o(()=>oe(i.value,-1)),N=o(()=>{const{endsAt:s}=m.event;return s?Ne(s,M.value):!1}),C=o(()=>oe(i.value,-3)),R=o(()=>{const{endsAt:s}=m.event;return s?Ne(s,C.value):!1}),l=o(()=>m.event.completedAt||F.value?"bg-success text-white":R.value?"bg-danger text-white":N.value?"bg-warning text-gray-700":"");function v(){p("click",m.event)}return(s,r)=>{const k=_e("font-awesome-icon"),B=At,g=we;return a(),T(g,{class:"!h-10 w-full text-lg !p-0 !flex !items-stretch [&>span]:!flex [&>span]:!flex-1 [&>span]:!overflow-hidden",disabled:s.disabled,onClick:Re(v,["prevent"])},{default:y(()=>[e(c)?(a(),I("div",{key:0,class:V(["text-xs leading-tight px-1 flex flex-col justify-center items-center h-full rounded-l",e(l)])},[U("div",null,E(e(c)),1),U("div",null,E(e(f)),1)],2)):S("",!0),U("div",Ts,[h(B,{"is-dot":"",hidden:!e(w),class:"badge overflow-x-hidden"},{default:y(()=>[U("div",Ss,E(e(xe)(s.event.assignment,s.assignmentNameToShow)),1),s.eventUsers.length?(a(),I("div",Es,[h(k,{icon:"user",class:"mr-1 opacity-60"}),L(" "+E(s.eventUsers.map($=>$.user?.shortName||$.user?.fullName||"").join(", ")),1)])):S("",!0)]),_:1},8,["hidden"])]),U("div",$s,[h(k,{icon:"angle-right",class:"text-xs"})])]),_:1},8,["disabled"])}}}),Cs={class:"container-assignments flex flex-col"},Ns={class:"flex justify-center text-center text-xl mb-2"},Ps={class:"px-1 mb-1"},Vs={class:"flex-1 relative overflow-y-auto"},Fs={class:"mt-2"},Ms={key:0,class:"bg-primary text-white text-center py-2 mb-1"},qs={class:"px-1"},Bs=ee({__name:"AssignmentList",props:{events:{},disabled:{type:Boolean,default:!1},activeEventUuids:{default:()=>[]},eventUsers:{default:()=>[]},assignmentNameToShow:{default:be[0]}},setup(x){const u=x,{t:m}=ye(),p=Ot(),_=P(null);function d(l){return l.getTime().toString()}const w=o(()=>{const l=_.value?.toLowerCase();return l?u.events.filter(v=>v.assignment?.number.toLowerCase()?.includes(l)):u.events}),c=Gt(),f=Ht({workDays:!0}),i=o(()=>{const l=[],v=Ve(w.value,"startsAt"),s=v.filter(k=>!k.startsAt||!k.endsAt),r=v.filter(k=>!!k.startsAt&&!!k.endsAt);if(r.length){const k=new Date(Math.min(...r.map(q=>q.startsAt.getTime()))),B=new Date(Math.max(...r.map(q=>q.endsAt.getTime())));let g=Pe(k),$=Q(Fe(k),{days:-1});for(;g.getTime()<=B.getTime();){const q={start:$,end:Fe(g)};let A=r.filter(W=>{const ne=W.startsAt,ie=W.endsAt&&W.endsAt>W.startsAt?W.endsAt:W.startsAt;return Tt(q,{start:ne,end:ie})});A=Ve(A,"endsAt").reverse(),A.length&&l.push({key:g.getTime().toString(),relative:c(g,new Date),date:g,events:A}),g=Q(g,{days:1}),$=Q($,{days:1})}}return s.length&&l.push({key:"null",date:null,events:s}),l}),F=o(()=>{const l={};for(const v of u.events)l[v.uuid]||(l[v.uuid]=[]);for(const v of u.eventUsers)l[v.eventUuid]||(l[v.eventUuid]=[]),l[v.eventUuid].push(v);return l}),M=o(()=>i.value.map(l=>l.date).filter(Ge)),N=P({}),C=is(Pe,{interval:{minutes:60}});G(C,()=>{N.value={},R()}),Ut(M,async()=>{R()},{debounce:200});async function R(){const l=[];if(M.value.forEach(s=>{if(!N.value[d(s)]){if(cs(s)||vs(s)||hs(s)||Yt(s)||Jt(s)){N.value[d(s)]=c(s,new Date);return}l.push(s)}}),!l.length||!p.value)return;const v=await Zt.service("calculate-working-times").calculateWorkingDaysForForAbsoluteDays({dates:l,companyId:p.value,dateToCompare:new Date});for(let s=0;s<v.counts.length;s++){const r=v.counts[s],k=l[s];N.value[k.getTime().toString()]=f(r,k)}}return(l,v)=>{const s=je;return a(),I("div",Cs,[U("div",Ns,E(e(m)("manufacturing.AssignmentList")),1),U("div",Ps,[h(s,{modelValue:e(_),"onUpdate:modelValue":v[0]||(v[0]=r=>K(_)?_.value=r:null),placeholder:e(m)("manufacturing.Search"),clearable:"",disabled:l.disabled},null,8,["modelValue","placeholder","disabled"])]),U("div",Vs,[U("div",Fs,[(a(!0),I(j,null,X(e(i),({key:r,date:k,relative:B,events:g})=>(a(),I("div",{key:r},[k||e(i).length!==1?(a(),I("div",Ms,[k?(a(),I(j,{key:0},[L(E(e(N)[d(k)]??B),1)],64)):(a(),I(j,{key:1},[L(E(e(m)("manufacturing.NotScheduled")),1)],64))])):S("",!0),U("div",qs,[(a(!0),I(j,null,X(g,$=>(a(),T(Ds,{key:$.uuid,disabled:l.disabled,type:l.activeEventUuids.includes($.uuid)?"danger":void 0,event:$,"event-users":e(F)[$.uuid],"assignment-name-to-show":l.assignmentNameToShow,class:"mb-1",onClick:()=>l.$emit("click-event",$)},null,8,["disabled","type","event","event-users","assignment-name-to-show","onClick"]))),128))])]))),128))])])])}}}),Ws=ze(Bs,[["__scopeId","data-v-b5a25ad6"]]),Ls=ee({__name:"RfidListener",emits:["scanned"],setup(x,{emit:u}){const m=u,p=te(""),_=te(null);function d(f,i,F){const{key:M,target:N}=f,C=()=>N.tagName!=="INPUT"&&N.tagName!=="TEXTAREA"&&N.tagName!=="VUE-ADVANCED-CHAT",R=()=>M.length===1,l=()=>M[0].match(/^[A-Za-z0-9]+$/)[0]===M[0];return C()&&R()&&l()}function w(f){p.value+=f.key,c(),_.value||(_.value=setTimeout(()=>{m("scanned",p.value),p.value="",_.value=null},300))}function c(){_.value&&(clearTimeout(_.value),_.value=null)}return(f,i)=>{const F=ms;return a(),T(F,{filter:d,onKeyup:Re(w,["prevent"])})}}}),Rs=ee({__name:"ArtesaMarquee",props:{text:{type:String,default:""},type:{type:String,default:"danger"},duration:{type:String,default:"10"}},setup(x){const u=x,m=P(),p=P(),_=P(!1),d=P(0),w=o(()=>d.value?{width:`${d.value}px`}:{}),c=o(()=>u.text.replace(/\n/g,"").trim());G(c,()=>{f()});const f=St(function(){const i=p.value;i&&(d.value=0,$t(()=>{_.value=i.offsetWidth<i.scrollWidth,d.value=i.scrollWidth}))},350);return Et(window,"resize",f),f(),(i,F)=>(a(),I("div",{ref_key:"refMarquee",ref:m,class:V([`alert-${x.type}`,"marquee bg-danger text-white"])},[U("span",{ref_key:"refMarqueeSpan",ref:p,class:V([[{animating:e(_)},`duration-${x.duration}`],"marquee-span marquee-span1"]),style:Me(e(w))},E(e(c)),7),e(_)?(a(),I("span",{key:0,class:V([[{animating:e(_)},`duration-${x.duration}`],"marquee-span marquee-span2"]),style:Me(e(w))},E(e(c)),7)):S("",!0)],2))}}),js=ze(Rs,[["__scopeId","data-v-5ea627d2"]]),zs={class:"p-0 h-screen max-h-screen box-border flex flex-col self-stretch"},Os={class:"w-[13.5rem] text-center text-xl mb-2"},Gs={class:"h-0 flex-1 flex flex-col overflow-y-auto"},Hs={key:0},Ys={key:0,class:"max-sm:hidden"},Js={class:"flex gap-2 ml-2"},Zs={class:"flex flex-auto h-1 overflow-hidden"},Ks={class:"flex flex-1 flex-col height-full p-2 max-w-full bg-slate-100"},Qs={class:"flex justify-center items-center text-center text-xl mb-2"},Xs={class:"flex-1 mb-2 overflow-auto max-w-full"},en={key:0},tn={class:"flex w-80"},sn=ee({__name:"WorkSpace",props:{eventTypeId:{}},setup(x){const u=x,[m,p]=qe(),[_,d]=qe(),w=Pt(),{t:c}=ye(),f=Kt(),i=Qt(),F=Oe().createScope(),M=Xt().createScope(),N=es().createScope(),{assignmentNameToShow:C,toggle:R}=ds(),l=te(!1),v=P(null),s=P([]),r=P([]),k=te(!1),B=te(!1),g=Dt("manufacturing-show-finished-events",!0),$=o({get(){return i.lg?g.value:B.value},set(n){i.lg?g.value=n:B.value=n}}),q=te(!1);G(()=>u.eventTypeId,()=>{r.value=[]});const A=He(),W=ls(),[ne]=pe("manufacturingTimeout",{defaultValue:0}),ie=o(()=>f.signInMethod==="rfid"),[ke]=pe("RFIDEnabled",{defaultValue:!1}),Je=o(()=>ke.value&&ie.value);let H=null;G(()=>!!ne.value&&Je.value,n=>{n&&!H?Ze():!n&&H&&Ke()},{immediate:!0});function Ze(){if(H)return;const{idle:n}=ys({time:ne.value});H=G(n,t=>{t&&A.setUserActivity(!1)})}function Ke(){H&&(H(),H=null)}const Qe=ts().createScope(),{data:le}=Qe.useGet({id:()=>u.eventTypeId,lazy:!0}),{unaccountablePeriods:Xe}=Ye({user:null}),et=o(()=>Xe.value.filter(n=>n.eventTypeId===u.eventTypeId)),{activeOrPausedWorkPeriods:Ie}=us({user:null,eventTypeId:o(()=>u.eventTypeId)}),Y=ss(),{eventTypes:tt}=fs({useAllIfNoCapabilities:!0,userId:o(()=>A.activeUser?.id||Y.value?.id)}),{data:ue}=F.useFind({params:o(()=>{const n=Q(new Date,{months:-6}),t=Q(new Date,{months:-9});return{query:{typeId:u.eventTypeId,completedAt:null,$or:[{startsAt:null,confirmedAt:{$gt:t}},{startsAt:{$gt:n},confirmedAt:{$ne:null}}],$sort:{startsAt:1},$limit:1e3}}})}),J=P(""),{data:st,isPending:nt}=F.useFind({params:o(()=>{const n=Q(new Date,{days:-14}),t={query:{typeId:u.eventTypeId,completedAt:{$gt:n},$sort:{startsAt:1},$limit:50},debounceTime:250};return J.value&&(t.query["assignment.number"]=Le(J.value,!0,!0),t.query.completedAt={$ne:null}),t}),fetchParams:o(()=>{if(!$.value)return null;const n=Q(new Date,{days:-14}),t={query:{typeId:u.eventTypeId,completedAt:{$gt:n},$sort:{startsAt:1},$limit:50},debounceTime:250};return J.value&&(t.query["$assignment.number$"]=Le(J.value,!0,!0),t.query.completedAt={$ne:null}),t})}),at=o(()=>{const n=[];return st.value.forEach(t=>{!t.assignment||n.includes(t)||n.push(t)}),n}),{data:de}=N.useFindOnce({params:o(()=>({query:{eventId:{$in:ue.value.map(n=>n.id)},$sort:{createdAt:1}}})),items:o(()=>ue.value.map(n=>n.id)),fetchParams(n){return{query:{eventId:{$in:n},$limit:1e3}}}}),rt=o(()=>{const n=new Set;return Ie.value.forEach(t=>{t.userId&&n.add(t.userId)}),et.value.forEach(t=>{t.userId&&n.add(t.userId)}),de.value.forEach(t=>{t.userId&&n.add(t.userId)}),[...n]}),ce=o(()=>{const n=[];return Y.value?.id&&n.push(Y.value.id),n.push(...rt.value,...r.value),[...new Set(n)]}),{data:ot}=M.useFindOnce({params:o(()=>({query:{id:{$in:ce.value},$sort:{fullName:1}}})),items:ce,fetchParams:n=>({query:{id:{$in:n},$limit:-1}}),debounceTime:100}),Ae=o(()=>{const n=[];return ce.value.forEach(t=>{const D=ot.value.find(Z=>Z.id===t);D&&n.push(D)}),n}),ae=o(()=>{const n=[...Ae.value],t=s.value.filter(D=>!Ae.value.some(Z=>D.id===Z.id));return n.push(...t),n}),it=o(()=>ae.value.map(n=>n.id)),lt=o(()=>{const n={};return ae.value.forEach(t=>{n[t.id]=[]}),de.value.forEach(t=>{n[t.userId]||(n[t.userId]=[]),n[t.userId].push(t)}),n}),Ue=o(()=>{const n={};return ae.value.forEach(t=>{n[t.id]=[]}),Ie.value.forEach(t=>{t.userId&&(n[t.userId]||(n[t.userId]=[]),n[t.userId].push(t))}),n}),[Te]=pe("manufacturingMessage",{defaultValue:""});G(it,(n,t)=>{if(!Array.isArray(n)||!Array.isArray(t))return;const D=n.filter(Z=>!t.includes(Z));D.length&&r.value.push(...D)}),Ct(()=>{W.resetUser()});async function ut(n){const t=f.user?.id;return await f.authenticateRfid(n),t!==f.user?.id}async function dt(n){try{if(n===f.user?.rfid){A.activeUser?.id!==f.user?.id?A.setUserActivity(!0):A.toggleUserActivity(),A.activeUser?Se():mt(),f.signInMethod="rfid";return}if(await ut(n)){Se(),f.signInMethod="rfid";return}A.isUserActive||(Ee(),f.signInMethod="rfid")}catch(t){console.error(t),Ee()}}function ct(){v.value&&(s.value.push(v.value),A.setActiveUser(v.value),v.value=null)}function Se(){Y.value&&fe({title:"",message:`<b>${Y.value.fullName}</b> angemeldet`,dangerouslyUseHTMLString:!0,type:"success",duration:5e3,position:"bottom-right"})}function mt(){Y.value&&fe({title:"",message:`<b>${Y.value.fullName}</b> abgemeldet`,dangerouslyUseHTMLString:!0,type:"success",duration:5e3,position:"bottom-right"})}function Ee(){fe({title:"",message:"Anmeldung nicht erfolgreich!",type:"warning",duration:5e3,position:"bottom-right"})}const ft=o(()=>{if(!A.activeUser||!u.eventTypeId)return[];const t=(Ue.value[A.activeUser.id]||[]).map(D=>D.eventUuid);return[...new Set(t)]}),z=P(null);function me(n){z.value=n.id}const pt=o(()=>r.value.length?{query:{id:{$nin:r.value}}}:{});return Nt(()=>!A.activeUser&&z.value,()=>{z.value=null}),(n,t)=>{const D=_e("font-awesome-icon"),Z=je,O=we,vt=Rt,gt=Vt,ht=Ft,$e=Mt,De=qt,Ce=Bt,yt=Wt,_t=Lt;return a(),I("div",zs,[h(e(m),null,{default:y(({class:b})=>[h(Ws,{class:V(["h-full pt-2 box-border w-64",b]),events:e(ue),disabled:!e(A).activeUser,"active-event-uuids":e(ft),"event-users":e(de),"assignment-name-to-show":e(C),onClickEvent:me},null,8,["class","events","disabled","active-event-uuids","event-users","assignment-name-to-show"])]),_:1}),h(e(_),null,{default:y(({class:b})=>[re((a(),I("div",{class:V(["flex flex-col box-border transition-all overflow-x-hidden",[{"w-56 p-1 pt-2 border-l":e($),"w-0 p-0 border-l-0":!e($)},b]])},[U("div",Os,[h(D,{icon:"check",class:"mr-0.5 text-base"}),L(" "+E(e(c)("manufacturing.AssignmentListFinished")),1)]),h(Z,{modelValue:e(J),"onUpdate:modelValue":t[0]||(t[0]=se=>K(J)?J.value=se:null),clearable:"",placeholder:e(c)("manufacturing.Search"),class:"mb-1"},null,8,["modelValue","placeholder"]),U("div",Gs,[(a(!0),I(j,null,X(e(at),se=>(a(),T(O,{key:se.uuid,disabled:!e(A).activeUser||e(W).isPaused||e(W).isUnaccountableActive,class:"w-full mb-1 !h-10 truncate !p-2 [&>span]:!block [&>span]:truncate flex-none",onClick:()=>me(se)},{default:y(()=>[L(E(e(xe)(se.assignment,e(C))),1)]),_:2},1032,["disabled","onClick"]))),128))])],2)),[[_t,e(nt)]])]),_:1}),e(ke)?(a(),T(Ls,{key:0,onScanned:dt})):S("",!0),h(os,{class:V(e(A).activeUser?"bg-primary":"bg-warning")},{"left-left":y(()=>[e(i).md?S("",!0):(a(),T(O,{key:0,class:"md:hidden mr-2",onClick:t[1]||(t[1]=b=>q.value=!e(q))},{default:y(()=>[h(D,{icon:"angle-right",class:"text-xs"})]),_:1}))]),left:y(()=>[h(ht,{"split-button":!0,class:"self-center",onClick:t[2]||(t[2]=b=>e(w).push({name:"ViewShopfloorEntrance"}))},{dropdown:y(()=>[h(gt,null,{default:y(()=>[(a(!0),I(j,null,X(e(tt),b=>(a(),T(vt,{key:b.uuid,disabled:b.uuid===e(le)?.uuid,onClick:()=>e(w).push({name:e(ns).ViewManufacturingWorkSpace,params:{eventTypeId:b.id}})},{default:y(()=>[L(E(b.name),1)]),_:2},1032,["disabled","onClick"]))),128))]),_:1})]),default:y(()=>[h(D,{icon:"map-marker-alt","fixed-width":"",class:"hidden md:inline mr-2 text-xs"}),e(le)?(a(),I("span",Hs,E(e(le).name),1)):S("",!0)]),_:1})]),mid:y(()=>[e(A).activeUser?S("",!0):(a(),I("span",Ys,E(e(c)("pleaseLogin")),1))]),"right-right":y(()=>[U("div",Js,[e(A).isUserActive?(a(),T(O,{key:0,onClick:t[3]||(t[3]=b=>$.value=!e($))},{default:y(()=>[h(D,{icon:"angle-right",class:V(["transition-all text-xs",{"rotate-180":!e($)}])},null,8,["class"])]),_:1})):S("",!0),e(A).isUserActive?(a(),T(O,{key:1,onClick:t[4]||(t[4]=()=>k.value=!0)},{default:y(()=>[h(D,{icon:"cog",class:"text-xs"})]),_:1})):S("",!0),e(A).isUserActive?S("",!0):(a(),T(O,{key:2,onClick:t[5]||(t[5]=()=>e(f).logout())},{default:y(()=>[h(D,{icon:"sign-out-alt",class:"text-xs"})]),_:1}))])]),_:1},8,["class"]),e(Te)?(a(),T(js,{key:1,text:e(Te),type:"danger",duration:"90"},null,8,["text"])):S("",!0),U("div",Zs,[e(i).md?(a(),T(e(p),{key:0,class:"border-r border-gray-300 mb-2 shadow"})):S("",!0),U("div",Ks,[U("div",Qs,[h(D,{icon:"calendar-alt","fixed-width":"",class:"mr-1 text-xs"}),L(" "+E(e(c)("manufacturing.DailyTask")),1)]),U("div",Xs,[(a(!0),I(j,null,X(e(ae),b=>(a(),T(Us,{key:b.uuid,user:b,"event-users":e(lt)[b.id],"work-periods":e(Ue)[b.id],"assignment-name-to-show":e(C),onClickEvent:me},null,8,["user","event-users","work-periods","assignment-name-to-show"]))),128)),e(A).isSupervisor?(a(),I("div",en,[e(l)?(a(),T(De,{key:1},{default:y(()=>[h($e,{label:e(c)("actions.add")+":"},{default:y(()=>[U("div",tn,[h(ps,{modelValue:e(v),"onUpdate:modelValue":t[7]||(t[7]=b=>K(v)?v.value=b:null),params:e(pt),class:"w-full"},null,8,["modelValue","params"]),h(O,{disabled:!e(v),type:"primary",size:"default",onClick:ct},{default:y(()=>[h(D,{icon:"plus",class:"text-xs"})]),_:1},8,["disabled"])])]),_:1},8,["label"])]),_:1})):(a(),T(O,{key:0,type:"primary",size:"default",onClick:t[6]||(t[6]=b=>l.value=!0)},{default:y(()=>[h(D,{icon:"user-plus",class:"text-xs"})]),_:1}))])):S("",!0)]),re(h(as,{"event-type-id":n.eventTypeId,class:"bg-white shadow"},null,8,["event-type-id"]),[[ve,!!e(A).activeUser]])]),e(i).lg?(a(),T(e(d),{key:1,class:"border-gray-300 shadow"})):S("",!0)]),e(z)?(a(),T(rs,{key:2,id:e(z),"onUpdate:id":t[8]||(t[8]=b=>K(z)?z.value=b:null),user:e(W).user,onClosed:t[9]||(t[9]=b=>z.value=null)},null,8,["id","user"])):S("",!0),e(q)?(a(),T(Ce,{key:3,modelValue:e(q),"onUpdate:modelValue":t[10]||(t[10]=b=>K(q)?q.value=b:null),direction:"ltr",size:256,class:"w-64 [&>header.el-drawer\\_\\_header]:mb-0 [&>.el-drawer\\_\\_body]:p-0"},{default:y(()=>[h(e(p))]),_:1},8,["modelValue"])):S("",!0),!e(i).lg&&e($)?(a(),T(Ce,{key:4,modelValue:e($),"onUpdate:modelValue":t[11]||(t[11]=b=>K($)?$.value=b:null),direction:"rtl",size:224,class:"[&>header.el-drawer\\_\\_header]:mb-0 [&>.el-drawer\\_\\_body]:p-0"},{default:y(()=>[h(e(d))]),_:1},8,["modelValue"])):S("",!0),e(k)?(a(),T(yt,{key:5,modelValue:e(k),"onUpdate:modelValue":t[12]||(t[12]=b=>K(k)?k.value=b:null),class:"dialog-messagebox-[500px] self-start"},{header:y(()=>[h(D,{icon:"cog",class:"mr-2 text-xs"}),L(" "+E(e(c)("planningBoard.settings.title")),1)]),default:y(()=>[h(De,{"label-width":"130px","label-position":e(i).xs?"left":"top"},{default:y(()=>[h($e,{label:e(c)("planningBoard.settings.Text")+":"},{default:y(()=>[h(O,{onClick:e(R)},{default:y(()=>[L(E(e(C)==="name"?e(c)("assignment.property.name"):e(C)==="number"?e(c)("assignment.property.number"):e(C)==="addressProperty"?e(c)("assignment.relation.addressProperty"):e(C)==="customer"?e(c)("assignment.relation.customer"):""),1)]),_:1},8,["onClick"])]),_:1},8,["label"])]),_:1},8,["label-position"])]),_:1},8,["modelValue"])):S("",!0)])}}}),va=ee({__name:"ViewWorkSpace",props:{eventTypeId:{type:Number,required:!0}},setup(x){return(u,m)=>(a(),T(sn,{"event-type-id":x.eventTypeId},null,8,["event-type-id"]))}});export{va as default};
