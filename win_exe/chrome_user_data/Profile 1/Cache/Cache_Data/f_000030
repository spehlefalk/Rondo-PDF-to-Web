import{a as st}from"./ArtesaTimePickerForCalendar.vue_vue_type_style_index_0_lang-BBYnsASy.js";import{a as nt,u as rt,F as at}from"./useFullcalendar-CGsOBmOU.js";import{i as ot}from"./index-BVk_Mu3e.js";import{i as it}from"./index-CbtekCeJ.js";import{i as ut,a as lt}from"./index-DKugGBE7.js";import{t as dt}from"./index-CsgZOv_I.js";import{ah as ct,J as Ie,h as vt,C as Z,R as ge,be as ft,x as gt,aU as pe,a3 as pt,H as mt,z as ht,a_ as me,G as yt,V as he,a1 as Et}from"./index-M8nwXBBi.js";import{a as Ae,Z as d,b as Ce,o as A,aC as N,g as T,c as p,e as j,j as ye,e5 as ee,t as P,h as q,h0 as Ut,u as wt,s as Ee,w as xt,$ as It,eh as At,f as V,i as X,aj as Ue,k as Ct,eM as bt,eJ as Pt}from"./vendor-CJXdOFCa.js";import{_ as Tt}from"./AssignmentEventName.vue_vue_type_script_setup_true_lang-BrVc5Ffk.js";import{f as St,u as _t,r as we,g as kt,d as Ft}from"./assignment-events.helpers-DEIAJbEv.js";import{g as Nt,u as Gt}from"./useAssignmentNameToShow-CT9dDVHV.js";import{u as Bt}from"./user-capabilities.store-CT1KSZFU.js";import{a as Dt,u as $t}from"./gang-capabilities.store-Q4J3ULDu.js";import{A as Mt}from"./ArtesaTooltip-CzaCLuSr.js";import{g as Rt,a as Wt}from"./user-absences.helpers-C55N6n0p.js";import{u as Lt}from"./useIsUserOfRole-BciEmr9Y.js";import"./index-zBlMUfmj.js";import"./index-B3z-Az2g.js";import"./index-CgnmzLwJ.js";import"./colorHelpers-D-IKRuV7.js";import"./index-C4Rzlq_k.js";import"./index.browser-DP16PUbO.js";import"./useRole-B2COsB3X.js";const Ot={class:"overflow-hidden"},Ht={class:"title leading-4"},Vt={class:"text-sm overflow-hidden text-ellipsis whitespace-nowrap"},jt={key:0,class:"text-sm"},qt=Ae({__name:"CalendarEntry",props:{event:{},eventUsers:{},nameToShow:{default:ct[0]},hideEventUsers:{type:Boolean,default:!1},eventClass:{default:void 0}},setup(f){const g=f,b=d(()=>St(g.event)?.type?.icon),l=d(()=>g.eventUsers?.length?g.eventUsers.map(m=>m.user?.shortName||m.user?.fullName||"").join(", "):"");return(m,S)=>{const F=Ce("font-awesome-icon");return A(),N("div",Ot,[T("div",Ht,[T("div",Vt,[p(b)?(A(),j(F,{key:0,icon:p(b),"fixed-width":"",class:"mr-0.5"},null,8,["icon"])):ye("",!0),T("span",{class:ee({"line-through":!!m.event.completedAt})},P(p(Nt)(m.event.assignment,m.nameToShow)),3)]),q(Tt,{value:m.event,"line-through-on-completed":"",tag:"div",class:ee(["text-xs ml-0.5",m.eventClass])},null,8,["value","class"])]),!m.hideEventUsers&&p(l)?(A(),N("div",jt,[q(F,{icon:"user",class:"opacity-80 text-xs"}),T("span",null,P(p(l)),1)])):ye("",!0)])}}}),zt=f=>{const{eventUsers:g}=f,b=Ie().createScope();function l(y){return g.value.filter(h=>h.userUuid===y.uuid)}function m(y){return y.length?Math.max(...y.map(h=>h.order??0))??0:0}function S(y,h){const E=l(h);return E.some(L=>L.userUuid===y.uuid)?void 0:b.construct({companyId:h.companyId,user:y,event:h,order:m(E)+1})}function F(y,h){return g.value.filter(E=>E.eventUuid===y.uuid&&E.userUuid===h.uuid)}function W(y,h){return g.value.filter(E=>E.eventUuid===y.uuid&&h.some(_=>E.userUuid===_.uuid))}return{addEventUser:S,findEventUsersForEventAndUsers:W,findEventUserForEventAndUser:F}},Jt={key:1,class:"text-sm select-none"},Kt=["onClick"],Yt={class:"font-bold truncate"},Qt={class:"text-xs whitespace-normal"};function be(f,g){return Array.isArray(g)?g.includes(f.extendedProps?.type):f.extendedProps?.type===g}function Zt(f){return be(f,["userEvent","gangUserEvent"])}function xe(f){return f.extendedProps?.assignmentEvent!==void 0}function U(f,g){return Array.isArray(g)?g.includes(f?.extendedProps?.type):f?.extendedProps?.type===g}function R(f){return U(f,"user")||U(f,"gangUser")}function x(f,g,b){return f==="all"?"all":f==="gangUser"?`gang-${g}-user${b}`:`${f}-${g}`}const xs=Ae({__name:"FullCalendarSpecific",props:{dateRange:{},allEvents:{},events:{},eventUsers:{},eventTypes:{},users:{},holidays:{},view:{default:"calendar"},resolution:{default:"month"},isPending:{type:Boolean,default:!1},initiallyLoading:{type:Boolean,default:!1},startDate:{default:()=>new Date}},emits:["clicked-item","update:dateRange","update:startDate"],setup(f,{expose:g,emit:b}){const l=f,m=b,S=vt(),{assignmentNameToShow:F}=Gt(),W=Ut("Shift"),y=Lt(["craft","spectator"]),{t:h}=wt(),E=Ee(!0),_=Ee(!0),L=d(()=>l.users?.map(e=>e.id)??[]),te=d(()=>l.events.map(e=>e.id).filter(Z)),se=d(()=>ge(l.eventUsers,"eventId")),Pe=ft().createScope(),{data:ne,haveLoaded:Te}=Pe.useFind({params:d(()=>({query:{companyId:S.value,isActive:!0,$limit:-1}}))}),re=d(()=>l.dateRange?{query:{$limit:-1,status:"approved",companyId:S.value,endsAt:{$gt:l.dateRange.startsAt},startsAt:{$lt:l.dateRange.endsAt}}}:null),Se=gt().createScope(),{data:_e,haveLoaded:ke}=Se.useFind({params:re,fetchParams:d(()=>l.view!=="resource"?null:re.value)}),Fe=d(()=>ke.value||l.view!=="resource"),G=d(()=>{const{view:e,resolution:t}=l;if(e==="calendar")return t==="day"?"timeGridDay":t==="week"?"timeGridWeek":"dayGridMonthTwoMonths";if(e==="resource"){if(t==="day")return"resourceTimeGridDay";if(t==="week")return"resourceTimelineWeek";if(t==="month")return"resourceTimelineMonth"}return"dayGridMonthTwoMonths"}),Ne=d(()=>l.view!=="resource"),Ge=d(()=>G.value==="dayGridMonthTwoMonths"||G.value==="resourceTimelineMonth"||G.value==="resourceTimelineWeek"?"whitespace-nowrap":void 0),Be=Bt(),{users:ae}=Be.useUsersForAssignmentEventTypes({eventTypeIds:d(()=>l.eventTypes?.map(e=>e.id)??[]),companyId:S,loadAllOnNoEventTypes:!0,loadAllOnNotFound:!0}),oe=d(()=>L.value.length>0),De=d(()=>oe.value?ae.value.filter(e=>L.value.includes(e.id)):ae.value),$e=d(()=>pe(De.value,"id")),Me=Dt(),{gangs:Re}=Me.useGangsForAssignmentEventTypes({eventTypeIds:d(()=>l.eventTypes?.map(e=>e.id)??[]),companyId:S,loadAllOnNoEventTypes:!0,loadAllOnNotFound:!0}),C=pt().createScope(),{data:O}=C.useFindOnce({items:te,params:d(()=>({query:{eventId:{$in:te.value}}})),fetchParams:e=>({query:{eventId:{$in:e},$limit:-1}}),debounceTime:150,watchOnlyIf:()=>!l.initiallyLoading}),{usersByGangUuid:ie,allGangUsers:We}=$t(),B=d(()=>{const e={gangs:[],gangUsers:[],gangUsersByUserId:{},gangsWithUsers:[],users:[],userById:{},userWithoutGangById:{},usersWithoutGang:[]},t=$e.value,r={...t},o={...t},n=oe.value,s=(a,i)=>{const c=a.shortName||a.fullName,u=i.shortName||i.fullName;return c.localeCompare(u)};return Re.value.forEach(a=>{const i=We.value.filter(u=>u.gangId===a.id);if(n&&(!i.length||!i.every(u=>u.userId&&t[u.userId])))return;e.gangs.push(a),e.gangUsers.push(...i);const c=[];for(const u of i){const{user:v}=u;if(!v)return;o[v.id]&&delete o[v.id],r[v.id]=v,c.push(v)}e.gangsWithUsers.push({gang:a,gangUsers:i,users:c.sort(s)})}),e.userWithoutGangById=o,e.usersWithoutGang=Object.values(e.userWithoutGangById).sort(s),e.users=Object.values(r).sort(s),e.userById=pe(e.users,"id"),e.gangUsersByUserId=ge(e.gangUsers,"userId"),e}),{addEventUser:D,findEventUsersForEventAndUsers:Le,findEventUserForEventAndUser:ue}=zt({eventUsers:d(()=>l.eventUsers)});function Oe(e){return O.value.filter(t=>t.eventUuid===e.uuid)}function z(e,t){return O.value.filter(r=>r.eventUuid===e.uuid&&r.gangUuid===t.uuid)}function J(e,t){if(z(e,t).length)return;const r=Oe(e);return C.construct({companyId:e.companyId,eventId:e.id,gangId:t.id,order:r.length+1})}const I=Ie().createScope();async function $(e){const t=ie.value[e.gangUuid],{event:r}=e;if(!r||!t?.length)return;const o=t.map(n=>D(n,r)).filter(Z);o.length&&await I.save(o)}async function K(e){const t=ie.value[e.gangUuid],{event:r}=e;if(!r||!t?.length)return;const o=Le(r,t);o.length&&await I.remove(o)}const He=d(()=>{const e={};return O.value.forEach(t=>{e[t.gangUuid]||(e[t.gangUuid]=[]),e[t.gangUuid].push(t)}),e});function Y(e){const t=[];return(!e.confirmedAt||e.completedAt)&&t.push("opacity-70"),e.completedAt&&t.push("done"),{start:e.startsAt,end:e.endsAt,title:"",backgroundColor:kt(e),textColor:Ft(e),display:"block",classNames:t}}const Ve=d(()=>{const e=[],{gangUsersByUserId:t,userWithoutGangById:r}=B.value;return l.eventUsers.forEach(o=>{if(!o.userId||!o.userUuid||!o.event)return;const{userId:n,userUuid:s,event:a}=o,i=t[n],c=r[n];if(!i?.length&&!c)return;const u=Y(a);i?.length&&i.forEach(v=>{e.push({...u,resourceId:x("gangUser",v.gangUuid,s),extendedProps:{type:"gangUserEvent",assignmentEvent:a,gangUser:v,eventUser:o}})}),c&&e.push({...u,resourceId:x("user",s),extendedProps:{type:"userEvent",assignmentEvent:a,eventUser:o}})}),e}),je=d(()=>{const e=[];return B.value.gangs.forEach(t=>{const r=He.value[t.uuid];r&&r.forEach(o=>{o.event&&e.push({...Y(o.event),resourceId:x("gang",t.uuid),extendedProps:{type:"gangEvent",assignmentEvent:o.event,gangEvent:o}})})}),e}),qe=d(()=>{const e={};return B.value.gangUsers.forEach(t=>{const{gang:r,userId:o}=t;!r||!o||(e[o]||(e[o]=[]),e[o].push(r))}),e}),ze=d(()=>{const e=[],{gangUsersByUserId:t,userWithoutGangById:r,userById:o}=B.value;return _e.value.forEach(n=>{if(!n.userUuid||!n.userId||!n.startsAt||!n.endsAt||!n.user)return;const{userId:s}=n,a=o[s],i=r[s],c=t[s],u=qe.value[s];if(!a||!i&&!c?.length&&!u?.length)return;const v=n.type?.name??"",M={start:n.startsAt,end:new Date(n.endsAt.getTime()+1),backgroundColor:Rt(n),textColor:Wt(n),allDay:!0,editable:!1,title:v,resourceEditable:!1};u?.length&&u.forEach(w=>{e.push({...M,resourceId:x("gang",w.uuid),title:n.type?.name?`${v} (${a.fullName})`:"",extendedProps:{type:"absence",absence:n}})}),c?.length&&c.forEach(w=>{e.push({...M,resourceId:x("gangUser",w.gangUuid,w.userUuid),extendedProps:{type:"absence",absence:n}})}),i&&e.push({...M,resourceId:x("user",n.userUuid),extendedProps:{type:"absence",absence:n}})}),e}),Je=d(()=>l.holidays.map(e=>({start:e.startsAt,end:e.endsAt,resourceId:x("all"),extendedProps:{type:"holiday",holiday:e},backgroundColor:mt,textColor:ht,allDay:!0,editable:!1,title:e.name,resourceEditable:!1}))),Ke=d(()=>{const e=[];return l.allEvents.forEach(t=>{se.value[t.id]?.length||e.push(t)}),e}),Ye=d(()=>l.view==="resource"&&!_.value?[]:(l.view==="resource"?E.value?Ke.value:l.allEvents:l.events).map(t=>({...Y(t),resourceId:x("all"),extendedProps:{type:"event",assignmentEvent:t,eventUsers:se.value[t.id]??[]}}))),Q=d(()=>!l.initiallyLoading&&Fe.value&&Te.value),le=me(()=>Q.value?[...Ye.value,...Je.value,...l.view==="resource"?[...Ve.value,...je.value,...ze.value]:[]]:[],75,{maxWait:100}),de=me(()=>{if(!Q.value)return[];let e=0;const t=[{id:x("all"),title:"all",extendedProps:{type:"all",index:e++,laneClass:"resource-all",labelClass:"resource-all"}}];let r=0;const{gangsWithUsers:o,usersWithoutGang:n}=B.value;o.forEach(({gang:a,users:i},c)=>{const u=["resource-gang",c!==0?"resource-gang-not-first":""],v=[...u],M=i.map(w=>(w.shortName||w.fullName)??"").join(", ");t.push({id:x("gang",a.uuid),title:a.name,extendedProps:{type:"gang",gang:a,index:e++,subIndex:r++,laneClass:u.join(" "),labelClass:v.join(" "),usersList:M,hasUsers:!!i.length},children:i.length?i.map(w=>{let tt=0;return{id:x("gangUser",a.uuid,w.uuid),title:w.shortName||w.fullName||"",extendedProps:{type:"gangUser",gang:a,user:w,index:e++,subIndex:tt++,laneClass:"",labelClass:""}}}):void 0})});let s=0;return n.forEach((a,i)=>{const c=["resource-user",o.length&&i===0?"resource-user-first":""],u=[...c];t.push({id:x("user",a.uuid),title:a.shortName||a.fullName||"",extendedProps:{type:"user",user:a,index:e++,subIndex:s++,laneClass:c.join(" "),labelClass:u.join(" ")}})}),t},75,{maxWait:100}),H=yt().createScope(),Qe=_t();async function k(e){const t=I.findInStore({query:{eventId:e.id}}).length,r=Qe(e,t);r&&await H.save(r)}const{isLoading:Ze,asyncRevertFunction:ce}=nt(),{options:Xe,ref:ve,rerender:fe,toggleResourceExpanded:et}=rt({schedulerLicenseKey:"0643100174-fcs-1684754064",plugins:[dt,ot,it,ut,lt],initialView:G.value,initialDate:l.startDate,firstDay:1,views:{resourceTimelineWeek:{slotLabelFormat:[({date:e})=>he(e.marker,"EEEEEE dd.MM."),({date:e})=>e.hour.toString().padStart(2,"0")],slotMinTime:"04:00:00",slotMaxTime:"20:00:00"},resourceTimelineMonth:{slotLabelFormat:[{week:"short"},({date:e})=>he(e.marker,"EEEEEE dd.MM.")],duration:{weeks:6}},dayGridMonthTwoMonths:{type:"dayGrid",dayHeaderFormat:{weekday:"long"},duration:{weeks:6},dayMaxEventRows:10}},scrollTime:null,scrollTimeReset:!1,headerToolbar:!1,selectable:!1,editable:!0,eventResizableFromStart:!1,eventDurationEditable:!1,droppable:!0,height:"auto",weekNumbers:!0,nowIndicator:!1,resourceAreaWidth:"180px",resourcesInitiallyExpanded:!1,slotMinWidth:d(()=>l.view==="resource"&&l.resolution==="week"?45:150),rerenderDelay:250,resourceAreaColumns:[{field:"title",headerContent:h("Employee")}],resourceOrder:"index",defaultTimedEventDuration:"01:00",forceEventDuration:!0,eventResourceEditable:!y.value,eventClick:({event:e})=>{xe(e)&&m("clicked-item",e.extendedProps.assignmentEvent)},eventDrop:ce(async e=>{const{event:t}=e;if(y.value||!xe(t)||!t.start||!t.end)return!1;const{assignmentEvent:r}=t.extendedProps,{oldResource:o,newResource:n}=e;if(o===n){const{start:s,end:a}=t,i=r.dateAnchor!=="endsAt"?"forward":"backward",c=await we(r,{date:i==="forward"?s:a,direction:i});for(const u in c)r[u]=c[u];await H.save(r);return}if(o)if(U(o,"all")){if(n&&R(n)){const{user:s}=n.extendedProps;if(ue(r,s)[0])return!1;const i=D(s,r);i&&(await I.save(i),await k(r))}else if(n&&U(n,"gang")){const{gang:s}=n.extendedProps;if(z(r,s).length)return!1;const a=J(r,s);if(a)await C.save(a),await $(a),await k(r);else return!1}}else if(R(o)){if(!Zt(t))return!1;if(n){if(U(n,"gang")){const{gang:s}=n.extendedProps;if(z(r,s).length)return!1;const{eventUser:a}=t.extendedProps,i=J(r,s);if(i)await I.remove(a),await C.save(i),await $(i),await k(r);else return!1}else if(R(n)){const s=n.extendedProps.user;if(W.value){const a=D(s,r);a&&(await I.save(a),await k(r))}else{const{eventUser:a}=t.extendedProps;a.userId=s.id,await I.save(a)}t.extendedProps}else if(U(n,"all")){const{eventUser:s}=t.extendedProps;await I.remove(s)}}else return!1}else if(U(o,"gang")){if(!be(t,"gangEvent"))return!1;if(n){if(R(n)){const{gangEvent:s,assignmentEvent:a}=t.extendedProps,{user:i}=n.extendedProps;if(ue(a,i)[0])return!1;await K(s),await C.remove(s);const u=D(i,a);u&&await I.save(u),await k(a)}else if(U(n,"gang")){const{gangEvent:s}=t.extendedProps,a=n.extendedProps.gang;if(W.value){const i=O.value.reduce((u,v)=>v.order&&v.eventId===r.id&&v.order>u?v.order:u,0),c=await C.create({eventId:r.id,gangId:a.id,order:i+1});await $(c),await k(r)}else await K(s),s.gangId=a.id,await C.save(s),await $(s),await k(r)}else if(U(n,"all")){const{gangEvent:s}=t.extendedProps;await K(s),await C.remove(s)}}else return!1}else return!1;else return!1}),eventReceive:ce(async e=>{const{event:t,draggedEl:r}=e,o=JSON.parse(r.attributes["data-event"].value),n=H.localFind(o.id);if(!n||!t.start)return!1;let s=t.start;if(l.resolution==="week"||l.resolution==="day")n.isAllDay&&(n.isAllDay=!1);else if(l.resolution==="month"&&!n.isAllDay&&n.startsAtDefaultTime){const u=Et(n.startsAtDefaultTime);s=st(s,u)}const a=await we(n,{date:s,direction:"forward",isAllDay:n.isAllDay});for(const u in a)n[u]=a[u];await H.save(n);const i=t.getResources(),[c]=i;if(!c||i.length>1)return!1;if(R(c)){const{user:u}=c.extendedProps,v=D(u,n);v&&await I.save(v)}else if(U(c,"gang")){const{gang:u}=c.extendedProps,v=J(n,u);if(v)await C.save(v),await $(v);else return!1}else return!1}),slotLabelClassNames({level:e,view:t}){return t.type==="resourceTimelineWeek"&&e===1?"artesa-slot-hour":""},resourceLaneClassNames:({resource:e})=>e.extendedProps.laneClass,resourceLabelClassNames:({resource:e})=>e.extendedProps.labelClass,events:le,resources:de,businessHours:d(()=>{if(ne.value.length)return ne.value.map(e=>{if(!e.start||!e.end)return;const t=Math.floor(e.start/60/60),r=Math.floor((e.start-t*60*60)/60),o=Math.floor(e.end/60/60),n=Math.floor((e.end-o*60*60)/60);return{daysOfWeek:[e.weekday],startTime:`${t.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`,endTime:`${o.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`}}).filter(Z)})},{dateRange:d({get:()=>l.dateRange,set:e=>m("update:dateRange",e)}),currentView:G,calendarDate:d({get:()=>l.startDate,set:e=>m("update:startDate",e)})});return xt(()=>ve.value&&Q.value,async()=>{await It(),!(l.view!=="resource"&&!le.value.length&&de.value.length>0)&&(await new Promise(e=>setTimeout(e,500)),fe())}),g({rerender:fe}),(e,t)=>{const r=bt,o=Ce("font-awesome-icon"),n=Pt;return At((A(),j(p(at),{ref_key:"refCalendar",ref:ve,options:p(Xe),class:"fc-planning-board flex-1"},{eventContent:V(({event:s})=>[s.extendedProps.assignmentEvent?(A(),j(qt,{key:0,event:s.extendedProps.assignmentEvent,"event-users":s.extendedProps.eventUsers,"hide-event-users":p(Ne),"event-class":p(Ge),"name-to-show":p(F)},null,8,["event","event-users","hide-event-users","event-class","name-to-show"])):(A(),N("div",Jt,P(s.title),1))]),resourceLabelContent:V(({resource:s})=>[U(s,"gang")?(A(),N("div",{key:0,class:ee([s.extendedProps.hasUsers?"cursor-pointer":""]),onClick:a=>p(et)(s.id)},[T("div",Yt,P(s.title),1),T("div",Qt,P(s.extendedProps.usersList),1)],10,Kt)):U(s,"user")||U(s,"gangUser")?(A(),j(Mt,{key:1,disabled:!s.extendedProps.user.shortName,content:s.extendedProps.user.fullName},{default:V(()=>[X(P(s.extendedProps.user.shortName||s.extendedProps.user.fullName),1)]),_:2},1032,["disabled","content"])):U(s,"all")?(A(),N(Ue,{key:3},[q(r,{modelValue:p(E),"onUpdate:modelValue":t[0]||(t[0]=a=>Ct(E)?E.value=a:null)},{default:V(()=>[X(P(p(E)?p(h)("planningBoard.UnassignedAssignments"):p(h)("planningBoard.AllAssignments")),1)]),_:1},8,["modelValue"]),T("div",null,[T("button",{onClick:t[1]||(t[1]=()=>_.value=!p(_))},[q(o,{icon:p(_)?"angle-up":"angle-down"},null,8,["icon"])])])],64)):(A(),N(Ue,{key:2},[X(P(s.title),1)],64))]),_:1},8,["options"])),[[n,e.isPending||p(Ze)]])}}});export{xs as default};
