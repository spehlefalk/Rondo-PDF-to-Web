const __vite__fileDeps=["assets/ContextChat-C3R1CP90.js","assets/ContextChat.vue_vue_type_script_setup_true_lang-DMFjjzb7.js","assets/vendor-CJXdOFCa.js","assets/vendor-jIhZnUxc.css","assets/index.browser-DP16PUbO.js","assets/index-M8nwXBBi.js","assets/index-Cpd7lwzu.css","assets/upload.store-BC_PBlNG.js","assets/useAssignmentNameToShow-CT9dDVHV.js"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{u as Is}from"./useRouterGoBack-B-wkT7yi.js";import{Z as js,a as He,$ as Bs,a0 as Ke,d as Je,_ as Fs,V as Re,a1 as Os,C as be,e as Rs,a2 as qe,w as qs,l as Ze,M as zs,N as Ms,G as Ns,O as Gs,J as Ws,a3 as Ls,W as Hs,a4 as Ks,P as Js,R as Zs,b as Qs,k as Xs,a5 as Ys}from"./index-M8nwXBBi.js";import{a as H,r as B,u as ee,b as se,o,aC as E,g as t,e5 as ae,e as S,j as x,h as s,t as c,c as e,f as n,i as I,l as X,f8 as Qe,Z as k,aj as Z,e6 as le,X as _e,f9 as et,fa as st,eh as oe,ei as $e,eo as ze,w as Ce,s as Xe,eE as Ye,k as K,f5 as tt,m as Ee,fb as nt,aF as at,eJ as we,f4 as ot,dZ as lt,eg as it,fc as rt,eZ as dt,fd as Me,a3 as ut,V as es,er as mt,ep as ct,eq as pt,e1 as ft,e2 as gt,fe as vt,ff as yt,aB as ss,fg as _t,$ as he,eV as ht,e0 as kt,eW as bt}from"./vendor-CJXdOFCa.js";import{e as $t,f as ts,_ as Ne,a as Ct,c as Et,d as wt,b as At}from"./AddressPropertyForm.vue_vue_type_script_setup_true_lang-CAvYtMeD.js";import{A as Ae}from"./ArtesaTooltip-CzaCLuSr.js";import{_ as xt}from"./FormCustomer.vue_vue_type_script_setup_true_lang-CImLeE6h.js";import{_ as Tt,a as St,A as Vt,u as Ut,b as Dt,c as Pt}from"./useCustomForms-BO40DnxB.js";import{O as It}from"./index-CAbXtJ5f.js";import{_ as xe}from"./AssignmentEventName.vue_vue_type_script_setup_true_lang-BrVc5Ffk.js";import{_ as jt}from"./ChangeEventUsers.vue_vue_type_script_setup_true_lang-DgRvO8Or.js";import{u as Bt,r as Ge}from"./assignment-events.helpers-DEIAJbEv.js";import{u as ns}from"./AddressMap.vue_vue_type_script_setup_true_lang-DupxI1iS.js";import{_ as Ft}from"./FeathersSelectAutocomplete.vue_vue_type_style_index_0_lang-D553730i.js";import{g as Ot}from"./colorHelpers-D-IKRuV7.js";import{_ as Rt}from"./SelectCustomer.vue_vue_type_script_setup_true_lang-DfY0-wua.js";import{_ as qt}from"./ContextChat.vue_vue_type_script_setup_true_lang-DMFjjzb7.js";import{i as zt}from"./index-BVk_Mu3e.js";import{i as Mt}from"./index-CbtekCeJ.js";import{i as Nt,a as Gt}from"./index-DKugGBE7.js";import{u as Wt,t as Lt}from"./index-CsgZOv_I.js";import{a as ke,_ as as}from"./ArtesaTimePickerForCalendar.vue_vue_type_style_index_0_lang-BBYnsASy.js";import{i as Ht}from"./index-BwiYwWtV.js";import{a as Kt,u as Jt,F as Zt}from"./useFullcalendar-CGsOBmOU.js";import{_ as Qt}from"./SelectUser.vue_vue_type_script_setup_true_lang-81euLzTY.js";import{_ as Xt}from"./SelectAssignmentEventType.vue_vue_type_script_setup_true_lang-D-40_Wby.js";import{_ as Yt}from"./AssignmentEventWorkPeriodTable.vue_vue_type_script_setup_true_lang-K3Z4fsBr.js";import{u as os}from"./useContainerQuery-odtNFs_8.js";import{_ as en}from"./TabCustomForms.vue_vue_type_script_setup_true_lang-B5fPHoXJ.js";import{u as We}from"./useIsUserOfRole-BciEmr9Y.js";const sn={class:"flex"},tn={class:"flex-1"},nn={class:"flex flex-wrap justify-between"},an={key:0,class:"flex-grow text-end text-sm text-slate-600"},on={class:"max-h-[calc(100vh-40px)] box-border overflow-y-auto"},ln={class:"flex justify-end"},Le=H({__name:"CardAssignmentEventsEntry",props:{event:{},tasks:{},isEditAssignmentUsersActive:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1}},setup(b){const w=B(!1),{t:r}=ee(),l=Bt();function i(v){return js(v.startsAt,v.endsAt,{isAllDay:v.isAllDay})}return(v,$)=>{const g=se("font-awesome-icon"),P=X,A=Qe;return o(),E("div",sn,[t("div",tn,[t("div",nn,[t("div",{class:ae(["basis-auto flex-grow-0 flex-shrink items-center leading-tight",{"text-gray-400":!v.isEditAssignmentUsersActive&&!v.event.confirmedAt&&!v.event.completedAt}])},[v.event.completedAt?(o(),S(g,{key:0,icon:"check","fixed-width":"",class:"mr-0.5 text-xs"})):x("",!0),s(xe,{value:v.event},null,8,["value"])],2),v.isEditAssignmentUsersActive?x("",!0):(o(),E("div",an,c(i(v.event)),1))]),s(jt,{event:v.event,readonly:!v.isEditAssignmentUsersActive,class:"px-1",onAddUser:$[0]||($[0]=({eventUsers:y})=>e(l)(v.event,y.length,{showNotification:!0}))},null,8,["event","readonly"])]),v.isEditAssignmentUsersActive?x("",!0):(o(),S($t,{key:0,"read-only":"",value:v.event,class:"ml-1"},null,8,["value"])),s(A,{placement:"bottom-end",width:450,trigger:"click",visible:e(w),class:"ml-2","popper-class":"!bg-gray-100",persistent:!1,"popper-options":{modifiers:[{name:"preventOverflow",options:{altAxis:!0,boundary:"viewport",padding:5,escapeWithReference:!0}},{name:"eventListeners",options:{scroll:!1}}]},disabled:v.readonly},{reference:n(()=>[s(P,{text:"",size:"small",onClick:$[1]||($[1]=()=>w.value=!0)},{default:n(()=>[s(g,{icon:"ellipsis-v",class:"text-xs"})]),_:1})]),default:n(()=>[t("div",on,[s(e(It),{options:{ignore:[".el-popper",".v-popper__popper"]},onTrigger:$[3]||($[3]=()=>w.value=!1)},{default:n(()=>[s(ts,{event:v.event,tasks:v.tasks,class:"mb-2"},null,8,["event","tasks"]),t("div",ln,[s(P,{class:"px-2",text:"",onClick:$[2]||($[2]=()=>w.value=!1)},{default:n(()=>[I(c(e(r)("actions.Close")),1)]),_:1})])]),_:1})])]),_:1},8,["visible","disabled"])])}}}),rn={key:0,class:"border-b border-gray-200"},dn={class:"text-gray-500 text-sm font-bold bg-gray-200 py-0.5 pl-3 pr-1 flex justify-between items-center leading-8"},un={key:0},mn={key:1},cn=H({__name:"CardAssignmentEvents",props:{assignment:{},events:{},eventGroups:{},eventUsers:{},tasksByEventUuid:{},isEditAssignmentUsersActive:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1}},setup(b,{expose:w}){const r=b,{t:l}=ee(),i=He(),{groupsAndEventsToShow:v}=ns({events:k(()=>r.events),groups:k(()=>r.eventGroups)}),$=k(()=>{const y=[];return v.value.forEach(_=>{if(_.isGroup){const{group:d,events:U}=_.element;if(!U.length)return;const a=[];U.forEach(u=>{const p=r.eventUsers.filter(h=>h.eventUuid===u.uuid);a.push({uuid:u.uuid,type:"event",event:u,eventUsers:p})}),y.push({uuid:d.uuid,type:"group",group:d,eventData:a})}else{const d=_.element,U=r.eventUsers.filter(a=>a.eventUuid===d.uuid);y.push({uuid:d.uuid,type:"event",event:d,eventUsers:U})}}),y});function g(y){return y.every(_=>!!_.confirmedAt)}function P(){return A(r.events)}function A(y){g(y)?y.forEach(d=>{d.confirmedAt&&(d.confirmedAt=null,d.confirmedById=null)}):y.forEach(d=>{d.confirmedAt||(d.confirmedAt=new Date,d.confirmedById=i.value?.id??null)})}return w({confirmAllEvents:P}),(y,_)=>{const d=se("font-awesome-icon"),U=X,a=Ae;return o(),E("div",null,[(o(!0),E(Z,null,le(e($),u=>(o(),E(Z,{key:u.uuid},[u.type==="group"?(o(),E("div",rn,[t("div",dn,[t("div",null,[u.group?(o(),E("span",un,c(u.group.type&&u.group.type.name),1)):(o(),E("span",mn,c(e(l)("Other")),1))]),!y.isEditAssignmentUsersActive&&!y.readonly?(o(),S(a,{key:0,effect:"dark",content:e(l)("cardAssignmentSteps.authorizeGroup",{group:u.group&&u.group.type&&u.group.type.name}),placement:"top"},{default:n(()=>[s(U,{size:"small",onClick:()=>A(u.eventData.map(p=>p.event))},{default:n(()=>[s(d,{icon:["far","thumbs-up"],class:"text-xs"})]),_:2},1032,["onClick"])]),_:2},1032,["content"])):x("",!0)]),(o(!0),E(Z,null,le(u.eventData,({event:p})=>(o(),S(Le,{key:p.uuid,event:p,tasks:y.tasksByEventUuid[p.uuid]??[],"is-edit-assignment-users-active":y.isEditAssignmentUsersActive,readonly:y.readonly,class:ae(["border-l-2 border-r border-gray-200 py-1 pl-2",[y.readonly?"pr-2":"pr-1"]])},null,8,["event","tasks","is-edit-assignment-users-active","readonly","class"]))),128))])):(o(),S(Le,{key:1,event:u.event,tasks:y.tasksByEventUuid[u.event.uuid]??[],"is-edit-assignment-users-active":y.isEditAssignmentUsersActive,readonly:y.readonly,class:ae(["py-1 pl-2",[y.readonly?"pr-2":"pr-1"]])},null,8,["event","tasks","is-edit-assignment-users-active","readonly","class"]))],64))),128))])}}}),pn=b=>{const w=`${b.singleObjectRelation}Id`,r=`${b.singleObjectRelation}Uuid`,l=`${b.multiObjectRelation}Id`;`${b.multiObjectRelation}`;const i=p=>{let h;const V=e(b.params);if(e(b.fetchParams),h=V,h)h=et({query:{}},h);else return{query:{}};return h},v=k(()=>{const p=_e(b.singleObject);if(!p)return null;const h=i();return h.query[r]=p.uuid,h}),$=k(()=>{const p=_e(b.singleObject);if(!p?.id)return null;const h=i();return h.query[w]=p.id,h}),{data:g,hasChanges:P,save:A,cancel:y,markForRemove:_,reset:d}=b.mnStore.useFeathersItems({params:v,fetchParams:$,limit:b.limit,localOnly:b.localOnly}),U=k(()=>[...new Set(g.value.map(p=>p[l]))]),a=k(()=>b.multiStore.localFind(U.value));function u(p){const h=_e(b.singleObject);if(!h)return;let V=Object.assign({},b.data,{[w]:h.id,[l]:p.id});b.beforeAdd&&(V=b.beforeAdd(V,{mnItems:g.value})),b.mnStore.construct(V)}return{mnItems:g,manyItems:a,removeTemp:_,hasChanges:P,save:A,cancel:y,reset:d,addItem:u}},ls=b=>{const w=Bs().createScope(),r=Ke().createScope(),{mnItems:l,manyItems:i,addItem:v,removeTemp:$,reset:g,save:P,hasChanges:A}=pn({mnStore:w,singleObject:b.assignment,multiStore:r,singleObjectRelation:"assignment",multiObjectRelation:"type",beforeAdd:(y,{mnItems:_})=>{const d=st(_,"order")?.order||0;return y.order=d+1,y},params:k(()=>({query:{$sort:{order:1}}})),localOnly:b.localOnly});return{assignmentTags:l,selectedAssignmentTagTypes:i,addAssignmentTagByTagType:v,removeTempAssignmentTag:$,resetTags:g,saveTags:P,tagsHaveChanges:A}},fn={key:0},gn={class:"md:flex"},vn={key:0,class:"flex items-center mr-1"},yn={class:"flex flex-1 flex-wrap"},_n={class:"flex flex-wrap flex-1"},hn=["onClick"],kn={key:1,class:"flex flex-1 items-center"},bn={key:0,class:"mt-0.5 ml-1"},$n={key:0},Cn={key:1},En={class:"flex items-center"},wn={class:"px-2"},An=H({__name:"AssignmentTags",props:{assignment:{type:Object,required:!0},readonly:{type:Boolean,default:!1}},setup(b){const w=b,{t:r}=ee(),l=Ke().createScope(),i=B(!1),{serverCount:v}=l.useCount({params:{query:{}}}),$=k(()=>(v.value??0)>0),{assignmentTags:g,selectedAssignmentTagTypes:P,addAssignmentTagByTagType:A,removeTempAssignmentTag:y}=ls({assignment:()=>w.assignment,localOnly:!0}),_=k(()=>P.value.length?{query:{id:{$nin:P.value.map(U=>U.id)},$sort:{order:1}}}:{});function d(U){i.value&&(U.isImportant=!U.isImportant)}return(U,a)=>{const u=se("font-awesome-icon"),p=X,h=Ae;return e($)&&(!b.readonly||e(g).length)?(o(),E("div",fn,[t("div",gn,[e(g).length?(o(),E("div",vn,c(e(r)("assignmentTags.category",2))+": ",1)):x("",!0),t("div",yn,[t("div",_n,[e(g).length?(o(!0),E(Z,{key:0},le(e(g),V=>(o(),E("div",{key:V.uuid,class:ae(["flex flex-1 border border-l-8 rounded m-0.5 min-w-44",{"cursor-pointer":e(i),"font-bold":V.isImportant}]),style:ze({"border-color":V.type?.color||"#000","background-color":e(Ot)(V.type?.color,.08)}),onClick:()=>!b.readonly&&d(V)},[t("div",{class:"flex-1 py-1 px-2",style:ze({"box-shadow":`inset 2px 0 5px -3px ${V.type?.color}`})},c(V.type?.name),5),e(i)&&!b.readonly?(o(),S(p,{key:0,text:"",size:"default",class:"px-2",onClick:()=>e(y)(V)},{default:n(()=>[s(u,{icon:"times"})]),_:2},1032,["onClick"])):x("",!0)],14,hn))),128)):(o(),E("div",kn,c(e(r)("assignmentTags.noAssignmentCategories")),1))]),b.readonly?x("",!0):(o(),E("div",bn,[e(i)?(o(),E("div",$n,[s(h,{effect:"dark",content:e(r)("assignmentTags.saveCategory"),placement:"top"},{default:n(()=>[s(p,{size:"default",type:"primary",onClick:a[0]||(a[0]=()=>i.value=!1)},{default:n(()=>[s(u,{icon:"check"})]),_:1})]),_:1},8,["content"])])):(o(),E("div",Cn,[s(h,{effect:"dark",content:e(r)("assignmentTags.assignmentCategory",2),placement:"top"},{default:n(()=>[s(p,{size:"default",onClick:a[1]||(a[1]=()=>i.value=!0)},{default:n(()=>[s(u,{icon:"pencil-alt"})]),_:1})]),_:1},8,["content"])]))]))])]),oe(t("div",En,[t("div",wn,[s(u,{icon:"plus"})]),s(Ft,{"model-value":null,store:e(l),params:e(_),"label-field":"name","color-field":"color","show-border":"",placeholder:e(r)("assignmentTags.addCategory"),size:"default",onChange:e(A)},null,8,["store","params","placeholder","onChange"])],512),[[$e,e(i)]])])):x("",!0)}}}),xn={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 gap-x-2 grid-rows-[auto,1fr]"},Tn={class:"flex justify-between"},Sn={class:"flex justify-between"},Vn={class:"flex justify-between"},Un={class:"flex gap-2"},Dn={class:"flex justify-between"},Pn={class:"flex justify-between"},In={key:0},jn={class:"flex justify-between"},Bn={class:"flex w-full h-16"},Fn={class:"grid grid-cols-1 md:grid-cols-2 gap-2 mt-4"},On={class:"border border-gray-200 px-3 py-2 rounded"},Rn={class:"border border-gray-200 px-3 py-2 rounded"},qn={class:"flex justify-end mt-4"},zn={class:"flex justify-end mt-4"},Mn={class:"flex justify-end mt-4"},Nn={class:"flex justify-end mt-4"},Gn=at(()=>Fs(()=>import("./ContextChat-C3R1CP90.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8]))),Wn=H({__name:"TabGeneral",props:{assignment:{},events:{},eventGroups:{},eventUsers:{},tasksByEventUuid:{},hideChat:{type:Boolean},readonly:{type:Boolean,default:!1}},setup(b){const w=b,{t:r}=ee(),l=Je(),i=k(()=>({assignmentId:w.assignment.id})),{hasUnreadMessages:v,markAsRead:$}=l.useHasUnreadChatMessages(i);Ce(()=>v.value&&!w.hideChat,()=>{$()});const g=B(),P=B(!1),A=B(!1),y=B(!1),_=B(!1),d=Xe(!1);function U(){g.value?.confirmAllEvents()}return(a,u)=>{const p=se("font-awesome-icon"),h=tt,V=X,N=Ae,F=Ee,O=we;return o(),E("div",null,[s(An,{assignment:a.assignment,readonly:a.readonly,class:"mb-2"},null,8,["assignment","readonly"]),t("div",xn,[t("div",null,[s(h,{class:"mb-2"},{header:n(()=>[t("div",Tn,[t("span",null,[s(p,{icon:"images",class:"mr-2 text-xs"}),I(" "+c(e(r)("file",2)),1)])])]),default:n(()=>[t("div",null,c(e(r)("temp.DetailedAssignmentMovedFiles")),1)]),_:1}),s(h,{class:"mb-2"},{header:n(()=>[t("div",Sn,[t("span",null,[s(p,{icon:"building",class:"mr-2 text-xs"}),I(" "+c(e(r)("assignment.form.addressPropertyShort")),1)]),a.$can("update",a.assignment,"property")&&!a.readonly?(o(),S(V,{key:0,size:"default",onClick:u[0]||(u[0]=j=>y.value=!0)},{default:n(()=>[s(p,{icon:"pencil-alt",class:"text-xs"})]),_:1})):x("",!0)])]),default:n(()=>[s(Tt,{assignment:a.assignment},null,8,["assignment"])]),_:1})]),t("div",null,[a.assignment.customer?(o(),S(h,{key:0,class:"mb-2"},{header:n(()=>[t("div",Vn,[t("span",null,[s(p,{icon:"user",class:"mr-2 text-xs"}),I(" "+c(e(r)("customer.name")),1)]),t("div",Un,[s(V,{size:"default",onClick:u[1]||(u[1]=j=>d.value=!0)},{default:n(()=>[s(p,{icon:"exchange-alt",class:"text-xs"})]),_:1}),a.$can("update",a.assignment,"customer")&&!a.readonly?(o(),S(V,{key:0,size:"default",onClick:u[2]||(u[2]=()=>A.value=!0)},{default:n(()=>[s(p,{icon:"pencil-alt",class:"text-xs"})]),_:1})):x("",!0)])])]),default:n(()=>[s(St,{modelValue:a.assignment.customer,"onUpdate:modelValue":u[3]||(u[3]=j=>a.assignment.customer=j)},null,8,["modelValue"])]),_:1})):x("",!0),s(h,{class:"mb-2"},{header:n(()=>[t("div",Dn,[t("span",null,[s(p,{icon:"folder-open",class:"mr-2 text-xs"}),I(" "+c(e(r)("project.name")),1)]),a.$can("update",a.assignment,"project")&&!a.readonly?(o(),S(V,{key:0,size:"default",onClick:u[4]||(u[4]=()=>_.value=!0)},{default:n(()=>[s(p,{icon:"pencil-alt",class:"text-xs"})]),_:1})):x("",!0)])]),default:n(()=>[s(Ne,{"model-value":a.assignment,"read-only":""},null,8,["model-value"])]),_:1})]),t("div",null,[s(h,{class:"[&_.el-card\\_\\_body]:p-1 mb-2"},{header:n(()=>[t("div",Pn,[t("div",null,[s(p,{icon:"tasks",class:"mr-2 text-xs"}),I(" "+c(e(r)("assignmentEvent.name",2)),1)]),!e(P)&&!a.readonly?(o(),S(N,{key:0,effect:"dark",content:e(r)("assignmentEvent.action.confirmAll"),placement:"top"},{default:n(()=>[s(V,{size:"default",onClick:U},{default:n(()=>[s(p,{icon:["far","thumbs-up"],class:"text-xs"})]),_:1})]),_:1},8,["content"])):x("",!0)])]),default:n(()=>[s(cn,{ref_key:"refCardAssignmentEvents",ref:g,assignment:a.assignment,events:a.events,"event-groups":a.eventGroups,"event-users":a.eventUsers,"tasks-by-event-uuid":a.tasksByEventUuid,"is-edit-assignment-users-active":e(P),readonly:a.readonly},null,8,["assignment","events","event-groups","event-users","tasks-by-event-uuid","is-edit-assignment-users-active","readonly"])]),_:1})]),a.assignment.id&&!a.hideChat?(o(),E("div",In,[s(h,{class:"[&_.el-card\\_\\_body]:p-0 mb-2"},{header:n(()=>[t("div",jn,[t("span",null,[s(p,{icon:"folder-open",class:"mr-2 text-xs"}),I(" "+c(e(r)("chat.chat")),1)]),s(V,{size:"default",icon:e(nt),onClick:u[5]||(u[5]=j=>a.assignment.id&&e(l).openChat(e(i)))},null,8,["icon"])])]),default:n(()=>[(o(),S(Ye,null,{fallback:n(()=>[oe(t("div",Bn,null,512),[[O,!0]])]),default:n(()=>[s(e(Gn),{context:e(i)},null,8,["context"])]),_:1}))]),_:1})])):x("",!0)]),e(y)?(o(),S(F,{key:0,modelValue:e(y),"onUpdate:modelValue":u[9]||(u[9]=j=>K(y)?y.value=j:null),title:`${e(r)("assignment.form.addressPropertyShort")} ${e(r)("actions.edit")}`,"append-to-body":"",width:"75%"},{default:n(()=>[t("h4",null,c(e(r)("assignment.form.addressProperty"))+":",1),s(Ct,{assignment:a.assignment,draggable:"",clickable:""},null,8,["assignment"]),t("div",Fn,[t("div",On,[t("h4",null,c(e(r)("assignment.property.constructionManager"))+":",1),s(Et,{modelValue:a.assignment.constructionManager,"onUpdate:modelValue":u[6]||(u[6]=j=>a.assignment.constructionManager=j)},null,8,["modelValue"])]),t("div",Rn,[t("h4",null,c(e(r)("assignment.property.architect"))+":",1),s(wt,{modelValue:a.assignment.architect,"onUpdate:modelValue":u[7]||(u[7]=j=>a.assignment.architect=j)},null,8,["modelValue"])])]),t("div",qn,[s(V,{type:"primary",onClick:u[8]||(u[8]=()=>y.value=!1)},{default:n(()=>[I(c(e(r)("OK")),1)]),_:1})])]),_:1},8,["modelValue","title"])):x("",!0),e(_)?(o(),S(F,{key:1,modelValue:e(_),"onUpdate:modelValue":u[11]||(u[11]=j=>K(_)?_.value=j:null),title:`${e(r)("project.name")} ${e(r)("actions.edit")}`,"append-to-body":"",width:"500px"},{default:n(()=>[s(Ne,{"model-value":a.assignment,"show-change-project-name":""},null,8,["model-value"]),t("div",zn,[s(V,{type:"primary",onClick:u[10]||(u[10]=()=>_.value=!1)},{default:n(()=>[I(c(e(r)("OK")),1)]),_:1})])]),_:1},8,["modelValue","title"])):x("",!0),e(A)?(o(),S(F,{key:2,modelValue:e(A),"onUpdate:modelValue":u[14]||(u[14]=j=>K(A)?A.value=j:null),title:`${e(r)("customer.name")} ${e(r)("actions.edit")}`,"append-to-body":"",width:"500px"},{default:n(()=>[a.assignment.customer?(o(),S(xt,{key:0,modelValue:a.assignment.customer,"onUpdate:modelValue":u[12]||(u[12]=j=>a.assignment.customer=j)},null,8,["modelValue"])):x("",!0),t("div",Mn,[s(V,{type:"primary",onClick:u[13]||(u[13]=()=>A.value=!1)},{default:n(()=>[I(c(e(r)("OK")),1)]),_:1})])]),_:1},8,["modelValue","title"])):x("",!0),e(d)?(o(),S(F,{key:3,modelValue:e(d),"onUpdate:modelValue":u[17]||(u[17]=j=>K(d)?d.value=j:null),"append-to-body":"",title:`${e(r)("customer.form.change")}`,width:"500px"},{default:n(()=>[s(Rt,{modelValue:a.assignment.customer,"onUpdate:modelValue":u[15]||(u[15]=j=>a.assignment.customer=j),"label-field":"fullName"},null,8,["modelValue"]),t("div",Nn,[s(V,{type:"primary",onClick:u[16]||(u[16]=j=>d.value=!1)},{default:n(()=>[I(c(e(r)("OK")),1)]),_:1})])]),_:1},8,["modelValue","title"])):x("",!0)])}}}),Ln={class:"flex w-full h-16"},Hn=H({__name:"TabChat",props:{assignment:{type:Object,required:!0}},setup(b){const w=b,r=Je(),l=k(()=>({assignmentId:w.assignment.id})),{hasUnreadMessages:i,markAsRead:v}=r.useHasUnreadChatMessages(l);return Ce(i,()=>{v()}),($,g)=>{const P=we;return o(),S(Ye,null,{fallback:n(()=>[oe(t("div",Ln,null,512),[[P,!0]])]),default:n(()=>[s(qt,{context:e(l),height:"calc(100vh - 190px)"},null,8,["context"])]),_:1})}}}),Kn={class:"flex mb-2"},Jn={class:"flex flex-1 items-start"},Zn={class:"max-h-[calc(100vh-40px)] box-border overflow-y-auto"},Qn={class:"flex justify-between"},Xn={class:"flex"},Yn={class:"w-48 mr-1"},ea=["data-event","onClick"],sa={class:"ml-1 text-xs"},ta={class:"flex-1"},na={key:0},aa={class:"leading-none"},oa={key:0},la={class:"artesa-resource"},ia={class:"flex"},ra={key:0,class:"ml-1"},da={key:1,class:"flex justify-end mt-2"},ua={key:0},ma={key:1},ca=H({__name:"TabGanttAssignment",props:{assignment:{},events:{},eventGroups:{},tasksByEventUuid:{},active:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1}},emits:["remove-event"],setup(b,{expose:w,emit:r}){const l=b,i=r,v=He(),{t:$}=ee(),g=B(),P=B("week"),A=k(()=>l.events.filter(m=>m.startsAt&&m.endsAt)),y=ot(A.value,"startsAt")?.startsAt,_=B(y?Ht(y)?ke(y,{weeks:-1}):y:new Date),d=k(()=>{let m=l.events.filter(C=>!C.startsAt||!C.endsAt);return m=Me(m,"order"),m.map(C=>({event:C,data:JSON.stringify({uuid:C.uuid})}))});lt(()=>{g.value&&new Wt(g.value,{itemSelector:".drag-resource-event"})});const U=k(()=>{let m=l.events.map(C=>C.type);return m=[...new Set(m)].filter(be),m=Me(m,"order"),m}),a=k(()=>P.value==="week"?"resourceTimelineMonth":"resourceTimelineWeek"),{isLoading:u,asyncRevertFunction:p}=Kt(),{ref:h,options:V,rerender:N}=Jt({schedulerLicenseKey:"0643100174-fcs-1684754064",plugins:[Lt,zt,Mt,Nt,Gt],initialView:"resourceTimelineMonth",firstDay:1,views:{resourceTimelineWeek:{slotLabelFormat:[({date:m})=>Re(m.marker,"EEEEEE dd.MM."),({date:m})=>m.hour.toString().padStart(2,"0")],duration:{days:14}},resourceTimelineMonth:{slotLabelFormat:[{week:"short"},({date:m})=>Re(m.marker,"EEEEEE dd.MM.")],duration:{weeks:6}}},scrollTime:null,headerToolbar:!1,droppable:!0,height:"auto",editable:!0,eventResizableFromStart:!1,eventDurationEditable:!1,weekNumbers:!0,nowIndicator:!0,resourceAreaWidth:"180px",slotMinWidth:k(()=>a.value==="resourceTimelineMonth"?80:30),resourceAreaColumns:k(()=>[{field:"title",headerContent:$("assignmentEvent.name",2)}]),events:k(()=>A.value.map(m=>{const C={start:m.startsAt,end:m.endsAt,resourceId:m.typeUuid,extendedProps:{event:m,timespanFormattedDays:m.workDays<2?$("assignmentEvent.durationTime",{duration:parseFloat((m.workingTimePerDay/3600).toFixed(2))}):$("assignmentEvent.durationDaysAndTime",{days:m.workDays,duration:parseFloat((m.workingTimePerDay/3600).toFixed(2))})},title:m.name||m.type?.name||"",classNames:"!bg-primary h-8"};return(!m.confirmedAt||m.completedAt)&&(C.classNames+=" opacity-60",m.completedAt&&(C.classNames+=" line-through")),C})),resources:k(()=>U.value.map((m,C)=>{let R="";const Q=A.value.filter(q=>q.type===m);return Q.length||(R="text-gray-400"),{id:m?.uuid,title:m?.name,index:C,extendedProps:{eventType:m,assignedEvents:Q,classNames:R},resourceClassNames:R}})),resourceOrder:"index",defaultTimedEventDuration:"01:00",eventResourceEditable:!1,eventClick:m=>{const C=m.event.extendedProps.event;O(C)},eventReceive:p(async m=>{const{event:C,draggedEl:R,revert:Q}=m;if(l.readonly||!C.start)return!1;const W=JSON.parse(R.attributes["data-event"].value),q=l.events.find(J=>J.uuid===W.uuid);if(!q)return!1;let D=C.start;if(P.value==="week"){const J=q.isAllDay?{hours:0,minutes:0,seconds:0}:q.startsAtDefaultTime?Os(q.startsAtDefaultTime):{hours:0,minutes:0,seconds:0};D=ke(D,J)}return await Ge(q,{date:D,direction:"forward",mutateEvent:!0}),!1}),eventDrop:p(async m=>{const{delta:C,event:R,revert:Q}=m;if(l.readonly)return!1;const W=R.extendedProps.event,{startsAt:q,endsAt:D}=W,J=(C.seconds??0)+(C.milliseconds??0)/1e3,ie=W.dateAnchor!=="endsAt"?"forward":"backward";await Ge(W,{date:ke(ie==="forward"?q:D,{seconds:J,minutes:C.minutes??0,hours:C.hours??0,days:C.days??0,months:C.months??0,years:C.years??0}),direction:ie,mutateEvent:!0}),F.value&&(F.value=W)}),slotLabelClassNames({level:m,view:C}){return m===1?"artesa-slot-hour":""}},{calendarDate:_,onChangeDate:({calendar:m})=>{m.scrollToTime("00:00")},currentView:a}),F=B(null);function O(m){F.value=m}const{recalculateOrder:j}=ns({events:k(()=>l.events),groups:k(()=>l.eventGroups)});async function te(){!F.value||l.readonly||(G(F.value),F.value=null,await j())}function Y(){ne.value?A.value.forEach(m=>{m.confirmedAt=null,m.confirmedById=null}):A.value.forEach(m=>{m.confirmedAt||(m.confirmedAt=new Date,m.confirmedById=v.value?.id??null)})}const ne=k(()=>A.value.every(m=>!!m.confirmedAt));function G(m){i("remove-event",m)}return Ce(()=>l.active===!1,()=>{F.value=null}),it(()=>{F.value=null}),w({forceRerender:N}),(m,C)=>{const R=X,Q=dt,W=se("font-awesome-icon"),q=Qe;return o(),E("div",null,[t("div",Kn,[t("div",Jn,[s(as,{modelValue:e(_),"onUpdate:modelValue":C[0]||(C[0]=D=>K(_)?_.value=D:null),size:"default","class-button-today":"hidden md:block",resolution:e(P)},null,8,["modelValue","resolution"])]),s(Q,null,{default:n(()=>[s(R,{disabled:e(P)==="week",size:"default",onClick:C[1]||(C[1]=()=>P.value="week")},{default:n(()=>[I(c(e($)("Days")),1)]),_:1},8,["disabled"]),s(R,{disabled:e(P)==="date",size:"default",onClick:C[2]||(C[2]=()=>P.value="date")},{default:n(()=>[I(c(e($)("Hours")),1)]),_:1},8,["disabled"])]),_:1}),e(F)?(o(),S(q,{key:0,placement:"bottom-end",width:450,visible:"",class:"ml-2","popper-class":"!bg-gray-100","popper-options":{modifiers:[{name:"preventOverflow",options:{altAxis:!0,boundary:"viewport",padding:5}}]}},{reference:n(()=>[s(R,{type:"primary",onClick:C[3]||(C[3]=()=>F.value=null)},{default:n(()=>[s(W,{icon:"pencil-alt",class:"text-xs"})]),_:1})]),default:n(()=>[t("div",Zn,[s(ts,{readonly:m.readonly,event:e(F),tasks:m.tasksByEventUuid[e(F).uuid]??[],class:"mb-2"},null,8,["readonly","event","tasks"]),t("div",Qn,[s(R,{type:"danger",plain:"",onClick:te},{default:n(()=>[s(W,{icon:"trash-alt",class:"text-xs"})]),_:1}),s(R,{class:"px-2",text:"",onClick:C[4]||(C[4]=()=>F.value=null)},{default:n(()=>[I(c(e($)("actions.Close")),1)]),_:1})])])]),_:1})):x("",!0)]),t("div",Xn,[oe(t("div",Yn,[t("div",null,c(e($)("assignmentEvent.Unscheduled"))+":",1),t("div",{ref_key:"refExternalEventsContainer",ref:g},[(o(!0),E(Z,null,le(e(d),({event:D,data:J})=>(o(),E("div",{key:D.uuid,class:ae(["drag-resource-event px-2 py-1 m-0.5 !bg-primary text-white rounded-sm cursor-pointer",{"opacity-60":!D.confirmedAt||!!D.completedAt,"line-through":!!D.completedAt}]),"data-event":J,onClick:()=>O(D)},[t("div",null,[D.completedAt?(o(),S(W,{key:0,icon:"check",class:"mr-1 text-xs"})):x("",!0),s(xe,{value:D},null,8,["value"])]),t("div",sa,[D.workDays<=1?(o(),E(Z,{key:0},[I(c(e($)("assignmentEvent.durationTime",{duration:parseFloat((D.workingTimePerDay/3600).toFixed(2))})),1)],64)):(o(),E(Z,{key:1},[I(c(e($)("assignmentEvent.durationDaysAndTime",{days:D.workDays,duration:parseFloat((D.workingTimePerDay/3600).toFixed(2))})),1)],64))])],10,ea))),128))],512)],512),[[$e,e(d).length]]),t("div",ta,[e(d).length?(o(),E("span",na,c(e($)("assignmentEvent.Scheduled"))+":",1)):x("",!0),s(e(Zt),{ref_key:"refCalendar",ref:h,class:"flex-1 fc-assignment",options:e(V)},rt({eventContent:n(({event:D})=>[t("div",aa,[D.extendedProps.event?(o(),E("div",oa,c(D.extendedProps.timespanFormattedDays),1)):x("",!0)])]),_:2},[m.readonly?void 0:{name:"resourceLabelContent",fn:n(({resource:D})=>[t("div",la,[t("div",{class:ae(["px-1",D.extendedProps.resourceClassNames])},[t("div",ia,[s(R,{text:"",size:"default",disabled:D.extendedProps.assignedEvents.length===0,class:"pt-0 pb-0 w-0 flex-1 !justify-start !font-normal line-clamp-1",onClick:()=>_.value=D.extendedProps.assignedEvents[0].startsAt},{default:n(()=>[I(c(D.title)+" ",1),D.extendedProps.assignedEvents.length?(o(),E("span",ra," ("+c(D.extendedProps.assignedEvents.length)+") ",1)):x("",!0)]),_:2},1032,["disabled","onClick"])])],2)])]),key:"0"}]),1032,["options"]),m.readonly?x("",!0):(o(),E("div",da,[e(A).length?(o(),S(R,{key:0,type:"primary",size:"default",onClick:Y},{default:n(()=>[e(ne)?(o(),E("span",ua,c(e($)("assignmentEvent.action.undoConfirmation")),1)):(o(),E("span",ma,c(e($)("assignmentEvent.action.confirmAll")),1))]),_:1})):x("",!0)]))])])])}}}),pa={class:"grid grid-cols-1 md:grid-cols-2 gap-2"},fa={class:"flex gap-1"},ga={class:"el-table"},va={class:"is-leaf el-table__cell"},ya={class:"cell"},_a={class:"is-center is-leaf el-table__cell"},ha={class:"cell"},ka={class:"is-center is-leaf el-table__cell"},ba={class:"cell"},$a={class:"is-center is-leaf el-table__cell"},Ca={class:"cell"},Ea={class:"el-table__cell"},wa={class:"cell"},Aa={class:"el-table__cell is-center"},xa={class:"cell"},Ta={class:"el-table__cell is-center"},Sa={class:"cell"},Va={class:"el-table__cell is-center"},Ua={class:"cell"},Da=H({__name:"TabAnalysis",props:{assignment:{type:Object,required:!0},events:{type:Array,required:!0}},setup(b){const w=b,{t:r}=ee(),l=Rs(),i=ut({range:"date",date:void 0,users:[],eventTypes:[]}),v=B({startsAt:null,endsAt:null}),$=B(["list"]),g=k(()=>{if(!w.assignment.id)return null;const _={query:{assignmentId:w.assignment.id}};return i.users?.length&&(_.query.userId={$in:i.users.map(d=>d.id)}),i.eventTypes?.length&&(_.query.eventTypeId={$in:i.eventTypes.map(d=>d.id)}),v.value?.startsAt&&(_.query.start={$lt:v.value.endsAt},_.query.$or||=[],_.query.$or.push({end:null},{end:{$gt:v.value.startsAt}})),_});function P(){return{assignmentId:w.assignment.id,companyId:w.assignment.companyId}}const A=B([]);es(()=>w.assignment.id,async _=>{if(!_)return;const d=await qs.service("assignment-event-work-periods").adjustedSumForAssignment({assignmentId:_});A.value=d},{immediate:!0});const y=k(()=>{const d=w.events.map(a=>{const u=A.value.find(h=>h.eventId===a.id)?.adjustedSum||0,p=a.manPower?u/a.manPower*100:0;return{event:a,manPower:a.manPower??0,booked:u,percentage:p,percentageToDisplay:p>1e4?"10000+%":`${p.toFixed(0)}%`}}),U=A.value.find(a=>a.eventId===null);return U&&d.unshift({booked:U.adjustedSum??0}),d});return(_,d)=>{const U=X,a=mt,u=ct,p=pt,h=ft,V=gt,N=vt,F=yt;return o(),S(F,{modelValue:e($),"onUpdate:modelValue":d[7]||(d[7]=O=>K($)?$.value=O:null)},{default:n(()=>[s(N,{title:e(r)("assignment.analysis.list"),name:"list"},{default:n(()=>[s(V,{"label-width":"105px","label-position":e(l).xs?"left":"top"},{default:n(()=>[t("div",pa,[s(h,{label:e(r)("Date")+":"},{default:n(()=>[t("div",fa,[s(p,null,{dropdown:n(()=>[s(u,null,{default:n(()=>[s(a,{disabled:e(i).range==="date",onClick:d[0]||(d[0]=()=>e(i).range="date")},{default:n(()=>[I(c(e(r)("Day")),1)]),_:1},8,["disabled"]),s(a,{disabled:e(i).range==="week",onClick:d[1]||(d[1]=()=>e(i).range="week")},{default:n(()=>[I(c(e(r)("Week")),1)]),_:1},8,["disabled"]),s(a,{disabled:e(i).range==="month",onClick:d[2]||(d[2]=()=>e(i).range="month")},{default:n(()=>[I(c(e(r)("Month")),1)]),_:1},8,["disabled"])]),_:1})]),default:n(()=>[s(U,null,{default:n(()=>[I(c(e(r)(e(i).range==="date"?"Day":e(i).range==="week"?"Week":"Month")),1)]),_:1})]),_:1}),s(as,{modelValue:e(i).date,"onUpdate:modelValue":d[3]||(d[3]=O=>e(i).date=O),resolution:e(i).range,"disabled-date":O=>O.getTime()>Date.now(),"hide-button-today":"",clearable:"",onInterval:d[4]||(d[4]=O=>v.value=O)},null,8,["modelValue","resolution","disabled-date"])])]),_:1},8,["label"]),s(h,{label:`${e(r)("Employee")}:`},{default:n(()=>[s(Qt,{modelValue:e(i).users,"onUpdate:modelValue":d[5]||(d[5]=O=>e(i).users=O),clearable:"",class:"w-full",multi:!0,"collapse-tags":""},null,8,["modelValue"])]),_:1},8,["label"]),s(h,{label:`${e(r)("assignmentEvent.name")}:`},{default:n(()=>[s(Xt,{modelValue:e(i).eventTypes,"onUpdate:modelValue":d[6]||(d[6]=O=>e(i).eventTypes=O),multi:!0,"collapse-tags":"","show-select-all":"","clear-on-select-all":"",clearable:"",class:"w-full"},null,8,["modelValue"])]),_:1},8,["label"])])]),_:1},8,["label-position"]),s(Yt,{params:e(g),"allow-assignment-edit":!1,"create-data":P,"csv-name-append":`-${e(r)("assignment.name",1)}-${w.assignment.number||w.assignment.name}`,"hide-project-in-table":"","hide-assignment-in-table":""},null,8,["params","csv-name-append"])]),_:1},8,["title"]),s(N,{title:e(r)("assignment.analysis.calculation"),name:"nominal-actual"},{default:n(()=>[t("table",ga,[t("thead",null,[t("tr",null,[t("th",va,[t("div",ya,c(e(r)("assignmentEvent.name",1)),1)]),t("th",_a,[t("div",ha,c(e(r)("assignment.analysis.estimatedManPower")),1)]),t("th",ka,[t("div",ba,c(e(r)("assignment.analysis.bookedManPower")),1)]),t("th",$a,[t("div",Ca,c(e(r)("Percentage")),1)])])]),t("tbody",null,[(o(!0),E(Z,null,le(e(y),({event:O,booked:j,manPower:te,percentageToDisplay:Y})=>(o(),E("tr",{key:O?.uuid??"null",class:"el-table__row"},[t("td",Ea,[t("div",wa,[s(xe,{value:O,"line-through-on-completed":""},null,8,["value"])])]),t("td",Aa,[t("div",xa,[te?(o(),E(Z,{key:0},[I(c(e(qe)(te,{hours:"always",minutes:"always"}).result)+" "+c(e(r)("hoursShort")),1)],64)):x("",!0)])]),t("td",Ta,[t("div",Sa,c(e(qe)(j,{hours:"always",minutes:"always"}).result)+" "+c(e(r)("hoursShort")),1)]),t("td",Va,[t("div",Ua,c(Y),1)])]))),128))])])]),_:1},8,["title"])]),_:1},8,["modelValue"])}}}),Pa={key:0,class:"ml-2"},Ia={class:"flex-1 flex flex-row gap-2 justify-end"},ja={key:1},Ba={key:2},Fa=H({__name:"DetailedAssignmentButtons",props:{assignment:{},hasChanges:{type:Boolean,default:!1},cloningInProgress:{type:Boolean,default:!1},isSavePending:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1},hideDelete:{type:Boolean,default:!1}},emits:["clicked-delete","clicked-cancel","clicked-save"],setup(b){const w=B(),{cq:r}=os(w),{can:l}=ss();return(i,v)=>{const $=se("font-awesome-icon"),g=X;return o(),E("div",{ref_key:"container",ref:w,class:"flex justify-between flex-wrap gap-3"},[e(l)("remove",i.assignment)&&!i.readonly&&!i.hideDelete?(o(),S(g,{key:0,type:"danger",plain:"",onClick:v[0]||(v[0]=()=>i.$emit("clicked-delete"))},{default:n(()=>[s($,{icon:"trash-alt",class:"text-xs"}),e(r).md?(o(),E("span",Pa,c(i.$t("actions.Delete")),1)):x("",!0)]),_:1})):x("",!0),t("div",Ia,[i.hasChanges?(o(),S(g,{key:0,text:!i.hasChanges,plain:"",type:i.hasChanges?"warning":void 0,onClick:v[1]||(v[1]=()=>i.$emit("clicked-cancel"))},{default:n(()=>[I(c(i.$t("actions.Cancel")),1)]),_:1},8,["text","type"])):x("",!0),s(g,{type:"primary",loading:i.isSavePending,onClick:v[2]||(v[2]=()=>i.hasChanges?i.$emit("clicked-save"):i.$emit("clicked-cancel"))},{default:n(()=>[i.hasChanges?(o(),S($,{key:0,icon:"check",class:"mr-2 text-xs"})):x("",!0),e(l)("patch",i.assignment)&&i.hasChanges&&!i.readonly?(o(),E("span",ja,c(i.$t("actions.Save")),1)):(o(),E("span",Ba,c(i.$t("actions.Close")),1))]),_:1},8,["loading"])])],512)}}}),Oa=H({__name:"TabFiles",props:{assignment:{}},setup(b){return(w,r)=>(o(),S(Vt,{"assignment-id":w.assignment.id,"company-id":w.assignment.companyId,"events-local":!0},null,8,["assignment-id","company-id"]))}}),Ra={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"},qa=t("path",{fill:"currentColor",d:"M6 8a1 1 0 0 0 0 2h4a1 1 0 1 0 0-2zm5 4a1 1 0 0 1 1-1h4a1 1 0 1 1 0 2h-4a1 1 0 0 1-1-1m4 2a1 1 0 1 0 0 2h3a1 1 0 1 0 0-2zM5.25 4A3.25 3.25 0 0 0 2 7.25v9.5A3.25 3.25 0 0 0 5.25 20h13.5A3.25 3.25 0 0 0 22 16.75v-9.5A3.25 3.25 0 0 0 18.75 4zM8 5.5V7h1.5V5.5h5V10H16V5.5h2.75c.966 0 1.75.784 1.75 1.75v9.5a1.75 1.75 0 0 1-1.75 1.75H16V17h-1q-.26 0-.5-.063V18.5h-5V11H8v7.5H5.25a1.75 1.75 0 0 1-1.75-1.75v-9.5c0-.966.784-1.75 1.75-1.75z"},null,-1),za=[qa];function Ma(b,w){return o(),E("svg",Ra,za)}const Na={name:"fluent-gantt-chart-24-regular",render:Ma},Ga={class:"font-light text-slate-500"},Wa={class:"mb-2"},La={class:"text-lg"},Ha={class:"text-lg"},Ka={class:"dialog-footer flex justify-end flex-wrap gap-1"},Ja={class:"dialog-footer flex justify-end flex-wrap gap-1"},Za=H({__name:"DetailedAssignment",props:{assignment:{}},emits:["discarded","deleted","saved"],setup(b,{expose:w,emit:r}){const l=b,i=r,v=B(),$=B(),{t:g}=ee(),{cq:P}=os($),A=k(()=>!P.value.xl),{can:y}=ss(),_=B("assignment");es(_,async f=>{f==="gantt"&&(await he(),v.value?.forceRerender())});const d=We(["craft","spectator"]),U=B(!1),a=B(!1),u=B(!1),p=B(!1),h=Ze().createScope(),V=zs().createScope(),N=Ms().createScope(),F=Ns().createScope(),O=Gs().createScope(),j=Ws().createScope(),te=Ls().createScope(),Y=Hs().createScope(),ne=Ut(),{data:G,markForRemove:m,save:C,reset:R,hasChanges:Q}=F.useFeathersItems({params:k(()=>({query:{assignmentId:l.assignment.id,$sort:{order:1}}})),fetchParams:k(()=>l.assignment.id?{query:{assignmentId:l.assignment.id,$limit:-1}}:null)}),W=B(0),q=k({get(){return G.value[W.value]},set(f){W.value=G.value.findIndex(T=>T.uuid===f.uuid)}}),{data:D,markForRemove:J,save:ie,reset:is,hasChanges:rs}=O.useFeathersItems({params:k(()=>({query:{assignmentId:l.assignment.id,$sort:{order:1}}})),fetchParams:k(()=>l.assignment.id?{query:{assignmentId:l.assignment.id,$limit:-1}}:null)});function ds(f,T){f&&J(f),m(T)}const{data:us,save:ms,reset:cs,hasChanges:ps}=j.useFindOnce({items:k(()=>G.value.map(f=>f.id)),params:k(()=>G.value.length?{query:{eventUuid:{$in:G.value.map(T=>T.uuid)},$sort:{order:1}}}:null),fetchParams:f=>(f=f.filter(be),{query:{eventId:{$in:f},$sort:{order:1},$limit:-1}})}),{data:eo,save:fs,reset:gs,hasChanges:vs}=te.useFindOnce({items:k(()=>G.value.map(f=>f.id)),params:k(()=>G.value.length?{query:{eventUuid:{$in:G.value.map(T=>T.uuid)},$sort:{order:1}}}:null),fetchParams:f=>(f=f.filter(be),{query:{eventId:{$in:f},$sort:{order:1}}})}),{hasTemplates:ys,customForms:Te,hasChanges:_s,save:hs,reset:ks}=Dt({companyId:()=>l.assignment.companyId,associatedParentServicePath:"assignments",associatedParentId:()=>l.assignment.id}),Se=Ks().createScope(),{serverCount:Ve}=Se.useCount({params:k(()=>l.assignment.id?{query:{associatedParentId:l.assignment.id,associatedParentServicePath:"stairs"}}:null)}),{hasChanges:bs,reset:$s,save:Cs}=Se.useFeathersItems({localOnly:!0,params:k(()=>l.assignment.id?{query:{associatedParentId:l.assignment.id,associatedParentServicePath:"stairs",$limit:-1}}:null)});let fe=null,Ue=null,De=!1,ge=!1,Pe=!1;const{saveTags:Es,resetTags:ws,tagsHaveChanges:As}=ls({assignment:()=>l.assignment}),ve=k(()=>h.hasChanges(l.assignment)||V.hasChanges(l.assignment.customer)||N.hasChanges(l.assignment.addressProperty)||N.hasChanges(l.assignment.customer?.address)||Y.hasChanges(l.assignment.project)||Q.value||rs.value||ps.value||vs.value||As.value||Vs.value||bs.value||ne.postponeTimeHasCome||_s.value);async function re(f){const{force:T=!1,skipEmit:L=!1}=f??{};return T||!ve.value||De||Pe?(T&&de(),ge=!0,L||i("discarded"),!0):(Ue=new Promise(z=>{fe=z}),a.value=!0,await Ue?(U.value=!1,de(),L||i("discarded"),ge=!0,!0):!1)}_t(async()=>ge?!0:await re({skipEmit:!0}));function de(){h.reset(l.assignment),V.reset(l.assignment.customer),N.reset(l.assignment.addressProperty),N.reset(l.assignment.customer?.address),Y.reset(l.assignment.project),cs(),gs(),R(),is(),ws(),Us(),$s(),ne.reset(),ks()}async function Ie(){try{if(p.value=!0,!y("patch",l.assignment)){de();return}await Promise.all([ie(),N.save(l.assignment.customer?.address??void 0),N.save(l.assignment.addressProperty??void 0),Y.save(l.assignment.project??void 0)]),await Promise.all([C(),Es()]),await Promise.all([ms(),fs(),Ds(),Cs(),hs(),V.save(l.assignment.customer??void 0)]),await h.save(l.assignment),await he(),await ne.savePostponedUploads(),De=!0,i("saved")}finally{p.value=!1}}const ye=B(!1);async function xs(){try{ye.value=!0,await h.remove(l.assignment)}finally{ye.value=!1}Pe=!0,i("deleted")}const Ts=Js().createScope(),{data:je,markForRemove:Ss,hasChanges:Vs,reset:Us,save:Ds}=Ts.useFeathersItems({params:k(()=>({query:{assignmentUuid:l.assignment.uuid,$limit:-1,$sort:{order:1}}})),fetchParams:k(()=>l.assignment.id?{query:{assignmentId:l.assignment.id,$limit:-1,$sort:{order:1}}}:null)}),ue=k(()=>Zs(je.value,"eventUuid"));async function Be(f){const{event:T}=f;if(Ss(f),!T)return;await he(),je.value.filter(z=>z.eventUuid===T.uuid).forEach((z,me)=>{const ce=me+1;z.order!==ce&&(z.order=ce)})}const Ps=We(["admin","superadmin"]),Fe=k(()=>{const f={assignment:l.assignment,customer:l.assignment.customer,address:l.assignment.addressProperty};if(!Object.values(f).some(T=>T===void 0))return f});return w({hasChanges:ve,save:Ie,reset:de,discard:re}),(f,T)=>{const L=se("font-awesome-icon"),z=ht,me=kt,ce=bt,pe=X,Oe=Ee;return o(),E("div",{ref_key:"refContainer",ref:$},[s(ce,{modelValue:e(_),"onUpdate:modelValue":T[3]||(T[3]=M=>K(_)?_.value=M:null),type:"card"},{default:n(()=>[s(z,{name:"assignment",lazy:""},{label:n(()=>[t("span",null,[s(L,{icon:"clipboard-list",class:"text-sm mr-1"}),I(" "+c(e(g)("DetailedAssignment.tab.general")),1)])]),default:n(()=>[s(Wn,{assignment:f.assignment,events:e(G),"event-groups":e(D),"event-users":e(us),"tasks-by-event-uuid":e(ue),"hide-chat":e(A),readonly:e(d)},null,8,["assignment","events","event-groups","event-users","tasks-by-event-uuid","hide-chat","readonly"])]),_:1}),e(d)?x("",!0):(o(),S(z,{key:0,name:"events-table",lazy:""},{label:n(()=>[t("span",null,[s(L,{icon:"tasks",class:"text-sm mr-1"}),I(" "+c(e(g)("assignmentEvent.name",2)),1)])]),default:n(()=>[s(At,{assignment:f.assignment,events:e(G),"event-groups":e(D),"tasks-by-event-uuid":e(ue),class:"max-w-7xl mx-auto",onRemoveEvent:e(m),onRemoveGroup:ds,onRemoveTask:Be},null,8,["assignment","events","event-groups","tasks-by-event-uuid","onRemoveEvent"])]),_:1})),e(A)?(o(),S(z,{key:1,name:"chat",lazy:""},{label:n(()=>[t("span",null,[s(L,{icon:["far","comments"],class:"text-sm mr-1"}),t("span",null,c(e(g)("chat.chat")),1)])]),default:n(()=>[s(Hn,{assignment:f.assignment},null,8,["assignment"])]),_:1})):x("",!0),s(z,{name:"files",lazy:""},{label:n(()=>[s(L,{icon:["far","folder-open"],class:"mr-1"}),t("span",null,[I(c(e(g)("file",2))+" ",1),t("span",Ga,c(e(Ve)?` (${e(Ve)})`:""),1)])]),default:n(()=>[s(Oa,{assignment:f.assignment},null,8,["assignment"])]),_:1}),e(ys)||e(Te).length>0?(o(),S(z,{key:2,name:"custom-form",lazy:""},{label:n(()=>[s(L,{icon:"file-invoice",class:"text-sm mr-1"}),t("span",null,c(e(g)("customForms.name",2)),1)]),default:n(()=>[e(Fe)?(o(),S(en,{key:0,"custom-forms":e(Te),"form-type":"ASSIGNMENT","company-id":f.assignment.companyId,"associated-service-path":"assignments","associated-id":f.assignment.id,"associated-parent-service-path":"assignments","associated-parent-id":f.assignment.id,context:e(Fe),location:"detailedAssignment"},null,8,["custom-forms","company-id","associated-id","associated-parent-id","context"])):x("",!0)]),_:1})):x("",!0),s(z,{name:"gantt",lazy:""},{label:n(()=>[t("span",null,[s(e(Na),{class:"inline mr-1"}),t("span",null,c(e(g)("assignment.process")),1)])]),default:n(()=>[s(ca,{ref_key:"refGantt",ref:v,assignment:f.assignment,events:e(G),"event-groups":e(D),active:e(_)==="gantt",readonly:e(d),"tasks-by-event-uuid":e(ue),onRemoveEvent:e(m)},null,8,["assignment","events","event-groups","active","readonly","tasks-by-event-uuid","onRemoveEvent"])]),_:1}),s(z,{name:"notes",lazy:""},{label:n(()=>[t("span",null,[oe(t("span",null,[s(L,{icon:"exclamation-circle",class:"text-sm mr-1 text-danger"})],512),[[$e,!!f.assignment.comment||!!f.assignment.notesBackOffice]]),t("span",null,c(e(g)("assignmentEvent.annotations")),1)])]),default:n(()=>[t("div",null,[t("div",Wa,[t("label",La,c(e(g)("assignment.notesForEmployee"))+":",1),s(me,{modelValue:f.assignment.comment,"onUpdate:modelValue":T[0]||(T[0]=M=>f.assignment.comment=M),rows:7,readonly:!f.$can("update",f.assignment,"comment")||e(d),disabled:!f.$can("update",f.assignment,"comment")||e(d),type:"textarea",placeholder:e(g)("assignment.notes")},null,8,["modelValue","readonly","disabled","placeholder"])]),t("div",null,[t("label",Ha,c(e(g)("assignment.notesForTheOffice"))+":",1),s(me,{modelValue:f.assignment.notesBackOffice,"onUpdate:modelValue":T[1]||(T[1]=M=>f.assignment.notesBackOffice=M),rows:7,readonly:!f.$can("update",f.assignment,"notesBackOffice")||e(d),disabled:!f.$can("update",f.assignment,"notesBackOffice")||e(d),type:"textarea",placeholder:e(g)("assignment.officeNotes")},null,8,["modelValue","readonly","disabled","placeholder"])])])]),_:1}),e(q)?(o(),S(z,{key:3,name:"tracking",lazy:""},{label:n(()=>[s(L,{icon:"clipboard-list",class:"text-sm mr-1"}),t("span",null,c(e(g)("Doing.name")),1)]),default:n(()=>[s(Pt,{event:e(q),"onUpdate:event":T[2]||(T[2]=M=>K(q)?q.value=M:null),tasks:e(ue)[e(q).uuid]??[],local:"",onRemoveTask:Be},null,8,["event","tasks"])]),_:1})):x("",!0),e(Ps)?(o(),S(z,{key:4,name:"analysis",lazy:""},{label:n(()=>[s(L,{icon:"search-plus",class:"text-sm mr-1"}),t("span",null,c(e(g)("assignment.Analysis")),1)]),default:n(()=>[s(Da,{assignment:f.assignment,events:e(G)},null,8,["assignment","events"])]),_:1})):x("",!0)]),_:1},8,["modelValue"]),s(Fa,{assignment:f.assignment,"is-save-pending":e(p),"has-changes":e(ve),"cloning-in-progress":e(u),readonly:e(d),"hide-delete":e(_)!=="assignment",class:"mt-3",onClickedSave:Ie,onClickedCancel:re,onClickedDelete:T[4]||(T[4]=M=>U.value=!0)},null,8,["assignment","is-save-pending","has-changes","cloning-in-progress","readonly","hide-delete"]),e(U)?(o(),S(Oe,{key:0,modelValue:e(U),"onUpdate:modelValue":T[7]||(T[7]=M=>K(U)?U.value=M:null),title:e(g)("assignment.deleteAssignment")+"?","append-to-body":"",class:"dialog-messagebox-[600px] dialog-center"},{footer:n(()=>[t("span",Ka,[s(pe,{text:"",onClick:T[5]||(T[5]=M=>U.value=!1)},{default:n(()=>[I(c(f.$t("actions.Cancel")),1)]),_:1}),s(pe,{type:"danger",loading:e(ye),onClick:T[6]||(T[6]=M=>xs())},{default:n(()=>[s(L,{icon:"trash-alt",class:"mr-2 text-xs"}),I(" "+c(e(g)("assignment.deleteAssignment")),1)]),_:1},8,["loading"])])]),default:n(()=>[t("span",null,c(e(g)("assignment.deleteWarning")),1)]),_:1},8,["modelValue","title"])):x("",!0),e(a)?(o(),S(Oe,{key:1,modelValue:e(a),"onUpdate:modelValue":T[10]||(T[10]=M=>K(a)?a.value=M:null),title:e(g)("discard.discardChanges")+"?","append-to-body":"",class:"dialog-messagebox-[600px] dialog-center"},{footer:n(()=>[t("span",Ja,[s(pe,{text:"",onClick:T[8]||(T[8]=M=>(a.value=!1,e(fe)&&e(fe)(!1)))},{default:n(()=>[I(c(e(g)("discard.continueEdit")),1)]),_:1}),s(pe,{type:"warning",plain:"",onClick:T[9]||(T[9]=M=>(a.value=!1,re({force:!0})))},{default:n(()=>[I(c(e(g)("discard.discardChanges")),1)]),_:1})])]),default:n(()=>[t("span",null,c(e(g)("discard.discardChangesMessage")),1)]),_:1},8,["modelValue","title"])):x("",!0)],512)}}}),Qa={class:"dialog-title"},Xa={key:0},Ya={key:1,style:{height:"100px"}},Uo=H({__name:"DialogDetailedAssignment",props:{assignmentId:{},goToName:{default:void 0},dontUseRouter:{type:Boolean,default:!1}},emits:["close"],setup(b,{emit:w}){const r=b,l=w,i=Xe(),v=Qs(),$=Xs(),g=k(()=>v.isLightBoxOpen||$.isOpen),P=Ze().createScope(),{data:A,isPending:y}=P.useGet({id:()=>r.assignmentId,fetchParams:k(()=>({$populateParams:{name:"assignmentDetailed"}}))});Ys("stairs","removed",p=>{p.id===r.assignmentId&&a()});const _=k(()=>{const p=[];return A.value?.number&&p.push(A.value.number),A.value?.name&&p.push(A.value.name),p.join(" - ")}),d=Is({keepQuery:!0});let U=!1;function a(){U=!0,r.dontUseRouter?l("close"):d()}async function u(p){(await i.value?.discard({skipEmit:U})??!0)&&p()}return(p,h)=>{const V=Ee,N=we;return o(),S(V,{"model-value":!!p.assignmentId,class:"dialog-messagebox-[1800px]","append-to-body":"","close-on-press-escape":!e(g),"before-close":u},{header:n(()=>[t("div",Qa,[e(A)?(o(),E("div",Xa,[t("span",null,c(e(_)),1)])):x("",!0)])]),default:n(()=>[e(A)?(o(),S(Za,{key:0,ref_key:"refDetailedAssignment",ref:i,assignment:e(A),onDiscarded:h[0]||(h[0]=()=>a()),onSaved:h[1]||(h[1]=()=>a()),onDeleted:h[2]||(h[2]=()=>a())},null,8,["assignment"])):oe((o(),E("div",Ya,null,512)),[[N,e(y)]])]),_:1},8,["model-value","close-on-press-escape"])}}});export{Uo as _};
